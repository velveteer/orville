<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FunctionalDependencies #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Orville.PostgreSQL.EntityTrace</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceT"><span class="hs-identifier">EntityTraceT</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceState"><span class="hs-identifier">EntityTraceState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#runEntityTraceT"><span class="hs-identifier">runEntityTraceT</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#insertEntityTraced"><span class="hs-identifier">insertEntityTraced</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#updateEntityTraced"><span class="hs-identifier">updateEntityTraced</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#deleteEntityTraced"><span class="hs-identifier">deleteEntityTraced</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TracedTable"><span class="hs-identifier">TracedTable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#mkTracedTable"><span class="hs-identifier">mkTracedTable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#addInsertTrace"><span class="hs-identifier">addInsertTrace</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#addUpdateTrace"><span class="hs-identifier">addUpdateTrace</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#addDeleteTrace"><span class="hs-identifier">addDeleteTrace</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#untracedTableDefinition"><span class="hs-identifier">untracedTableDefinition</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#MonadEntityTrace"><span class="hs-identifier">MonadEntityTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#recordTraces"><span class="hs-identifier">recordTraces</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#liftOrvilleUntraced"><span class="hs-identifier">liftOrvilleUntraced</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">where</span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ex</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.IO.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">liftIO</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadTrans</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">lift</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Reader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ReaderT</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ask</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">runReaderT</span></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.DList</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DList</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">traverse_</span></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">IORef</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">atomicModifyIORef'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">newIORef</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">readIORef</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Pool</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Pool</span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.html"><span class="hs-identifier">Orville.PostgreSQL</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">O</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Connection.html"><span class="hs-identifier">Orville.PostgreSQL.Connection</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Conn</span></span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span class="hs-comment">{- |
 'MonadEntityTrace' provides the interface used by functions such as
 'insertEntityTraced' to perform tracing as part of their operation. An
 instance for 'ReaderT EntityTraceState' is provided which can be used via
 'runEntityTraceT'.
-}</span><span>
</span><span id="line-43"></span><span class="hs-keyword">class</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679122659"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span id="MonadEntityTrace"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#MonadEntityTrace"><span class="hs-identifier hs-var">MonadEntityTrace</span></a></span></span><span> </span><span id="local-6989586621679122660"><span class="annot"><a href="#local-6989586621679122660"><span class="hs-identifier hs-type">trace</span></a></span></span><span> </span><span id="local-6989586621679122659"><span class="annot"><a href="#local-6989586621679122659"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="#local-6989586621679122659"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679122660"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-44"></span><span>  </span><span id="recordTraces"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#recordTraces"><span class="hs-identifier hs-type">recordTraces</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679122660"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679122659"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>  </span><span id="local-6989586621679122657"><span id="liftOrvilleUntraced"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#liftOrvilleUntraced"><span class="hs-identifier hs-type">liftOrvilleUntraced</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679122662"><span class="annot"><a href="#local-6989586621679122662"><span class="hs-identifier hs-type">n</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#MonadOrville"><span class="hs-identifier hs-type">O.MonadOrville</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122662"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679122662"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122657"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679122659"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122657"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span class="hs-comment">{- |
  INTERNAL: A list of functions for constructing traces
-}</span><span>
</span><span id="line-50"></span><span class="hs-keyword">newtype</span><span> </span><span id="Constructors"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#Constructors"><span class="hs-identifier hs-var">Constructors</span></a></span></span><span> </span><span id="local-6989586621679122739"><span class="annot"><a href="#local-6989586621679122739"><span class="hs-identifier hs-type">f</span></a></span></span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Constructors"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#Constructors"><span class="hs-identifier hs-var">Constructors</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DList.DList</span></span><span> </span><span class="annot"><a href="#local-6989586621679122739"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span id="local-6989586621679122699"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#emptyConstructors"><span class="hs-identifier hs-type">emptyConstructors</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#Constructors"><span class="hs-identifier hs-type">Constructors</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122699"><span class="hs-identifier hs-type">f</span></a></span></span><span>
</span><span id="line-54"></span><span id="emptyConstructors"><span class="annot"><span class="annottext">emptyConstructors :: Constructors f
</span><a href="Orville.PostgreSQL.EntityTrace.html#emptyConstructors"><span class="hs-identifier hs-var hs-var">emptyConstructors</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-55"></span><span>  </span><span class="annot"><span class="annottext">DList f -&gt; Constructors f
forall f. DList f -&gt; Constructors f
</span><a href="Orville.PostgreSQL.EntityTrace.html#Constructors"><span class="hs-identifier hs-var">Constructors</span></a></span><span> </span><span class="annot"><span class="annottext">DList f
forall a. DList a
</span><span class="hs-identifier hs-var">DList.empty</span></span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span id="local-6989586621679122676"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#addConstructor"><span class="hs-identifier hs-type">addConstructor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679122676"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#Constructors"><span class="hs-identifier hs-type">Constructors</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122676"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#Constructors"><span class="hs-identifier hs-type">Constructors</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122676"><span class="hs-identifier hs-type">f</span></a></span></span><span>
</span><span id="line-58"></span><span id="addConstructor"><span class="annot"><span class="annottext">addConstructor :: f -&gt; Constructors f -&gt; Constructors f
</span><a href="Orville.PostgreSQL.EntityTrace.html#addConstructor"><span class="hs-identifier hs-var hs-var">addConstructor</span></a></span></span><span> </span><span id="local-6989586621679122490"><span class="annot"><span class="annottext">f
</span><a href="#local-6989586621679122490"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#Constructors"><span class="hs-identifier hs-type">Constructors</span></a></span><span> </span><span id="local-6989586621679122489"><span class="annot"><span class="annottext">DList f
</span><a href="#local-6989586621679122489"><span class="hs-identifier hs-var">fs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-59"></span><span>  </span><span class="annot"><span class="annottext">DList f -&gt; Constructors f
forall f. DList f -&gt; Constructors f
</span><a href="Orville.PostgreSQL.EntityTrace.html#Constructors"><span class="hs-identifier hs-var">Constructors</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DList f -&gt; f -&gt; DList f
forall a. DList a -&gt; a -&gt; DList a
</span><span class="hs-identifier hs-var">DList.snoc</span></span><span> </span><span class="annot"><span class="annottext">DList f
</span><a href="#local-6989586621679122489"><span class="hs-identifier hs-var">fs</span></a></span><span> </span><span class="annot"><span class="annottext">f
</span><a href="#local-6989586621679122490"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span id="local-6989586621679122693"><span id="local-6989586621679122694"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#applyConstructors"><span class="hs-identifier hs-type">applyConstructors</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679122694"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679122693"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#Constructors"><span class="hs-identifier hs-type">Constructors</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122694"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679122693"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-62"></span><span id="applyConstructors"><span class="annot"><span class="annottext">applyConstructors :: (f -&gt; [a]) -&gt; Constructors f -&gt; [a]
</span><a href="Orville.PostgreSQL.EntityTrace.html#applyConstructors"><span class="hs-identifier hs-var hs-var">applyConstructors</span></a></span></span><span> </span><span id="local-6989586621679122486"><span class="annot"><span class="annottext">f -&gt; [a]
</span><a href="#local-6989586621679122486"><span class="hs-identifier hs-var">runF</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#Constructors"><span class="hs-identifier hs-type">Constructors</span></a></span><span> </span><span id="local-6989586621679122485"><span class="annot"><span class="annottext">DList f
</span><a href="#local-6989586621679122485"><span class="hs-identifier hs-var">fs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-63"></span><span>  </span><span class="annot"><span class="annottext">(f -&gt; [a]) -&gt; DList f -&gt; [a]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">f -&gt; [a]
</span><a href="#local-6989586621679122486"><span class="hs-identifier hs-var">runF</span></a></span><span> </span><span class="annot"><span class="annottext">DList f
</span><a href="#local-6989586621679122485"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-comment">{- |
  A 'TracedTable' is a regular 'O.TableDefinition' with callbacks for
  constructing the @trace@ items that will be captured when functions such as
  'insertEntityTraced' are used. Use 'mkTracedTable' to build a 'TracedTable'
  with no callbacks and then use 'addInsertTrace' and friends to register
  callbacks callbacks on the table.
-}</span><span>
</span><span id="line-72"></span><span class="hs-keyword">data</span><span> </span><span id="TracedTable"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TracedTable"><span class="hs-identifier hs-var">TracedTable</span></a></span></span><span> </span><span id="local-6989586621679122700"><span class="annot"><a href="#local-6989586621679122700"><span class="hs-identifier hs-type">trace</span></a></span></span><span> </span><span id="local-6989586621679122703"><span class="annot"><a href="#local-6989586621679122703"><span class="hs-identifier hs-type">key</span></a></span></span><span> </span><span id="local-6989586621679122702"><span class="annot"><a href="#local-6989586621679122702"><span class="hs-identifier hs-type">writeEntity</span></a></span></span><span> </span><span id="local-6989586621679122701"><span class="annot"><a href="#local-6989586621679122701"><span class="hs-identifier hs-type">readEntity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TracedTable"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TracedTable"><span class="hs-identifier hs-var">TracedTable</span></a></span></span><span>
</span><span id="line-73"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_untracedTableDefinition"><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
-&gt; TableDefinition (HasKey key) writeEntity readEntity
</span><a href="Orville.PostgreSQL.EntityTrace.html#_untracedTableDefinition"><span class="hs-identifier hs-var hs-var">_untracedTableDefinition</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.TableDefinition.html#TableDefinition"><span class="hs-identifier hs-type">O.TableDefinition</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.Internal.TableDefinition.html#HasKey"><span class="hs-identifier hs-type">O.HasKey</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122703"><span class="hs-identifier hs-type">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679122702"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122701"><span class="hs-identifier hs-type">readEntity</span></a></span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_getTracedEntityKey"><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity -&gt; readEntity -&gt; key
</span><a href="Orville.PostgreSQL.EntityTrace.html#_getTracedEntityKey"><span class="hs-identifier hs-var hs-var">_getTracedEntityKey</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679122701"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679122703"><span class="hs-identifier hs-type">key</span></a></span><span>
</span><span id="line-75"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_insertTraceConstructors"><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
-&gt; Constructors (writeEntity -&gt; readEntity -&gt; [trace])
</span><a href="Orville.PostgreSQL.EntityTrace.html#_insertTraceConstructors"><span class="hs-identifier hs-var hs-var">_insertTraceConstructors</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#Constructors"><span class="hs-identifier hs-type">Constructors</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679122702"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679122701"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679122700"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_updateTraceConstructors"><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
-&gt; Constructors
     (readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace])
</span><a href="Orville.PostgreSQL.EntityTrace.html#_updateTraceConstructors"><span class="hs-identifier hs-var hs-var">_updateTraceConstructors</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#Constructors"><span class="hs-identifier hs-type">Constructors</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679122701"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679122702"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679122701"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679122700"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_deleteTraceConstructors"><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
-&gt; Constructors (key -&gt; Maybe readEntity -&gt; [trace])
</span><a href="Orville.PostgreSQL.EntityTrace.html#_deleteTraceConstructors"><span class="hs-identifier hs-var hs-var">_deleteTraceConstructors</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#Constructors"><span class="hs-identifier hs-type">Constructors</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679122703"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679122701"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679122700"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="hs-comment">{- |
  Constructs a 'TracedTable' that wraps the given 'O.TableDefinition' so that
  it can be used with functions such as 'insertEntityTraced'. The resulting
  'TracedTable' has no trace callbacks initially. You can 'addInsertTrace' and
  similar functions ta add callbacks.
-}</span><span>
</span><span id="line-86"></span><span id="local-6989586621679122474"><span id="local-6989586621679122475"><span id="local-6989586621679122476"><span id="local-6989586621679122477"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#mkTracedTable"><span class="hs-identifier hs-type">mkTracedTable</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679122477"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679122476"><span class="hs-identifier hs-type">key</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-88"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Internal.TableDefinition.html#TableDefinition"><span class="hs-identifier hs-type">O.TableDefinition</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.Internal.TableDefinition.html#HasKey"><span class="hs-identifier hs-type">O.HasKey</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122476"><span class="hs-identifier hs-type">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679122475"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122477"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-89"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TracedTable"><span class="hs-identifier hs-type">TracedTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122474"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122476"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122475"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122477"><span class="hs-identifier hs-type">readEntity</span></a></span></span></span></span></span><span>
</span><span id="line-90"></span><span id="mkTracedTable"><span class="annot"><span class="annottext">mkTracedTable :: (readEntity -&gt; key)
-&gt; TableDefinition (HasKey key) writeEntity readEntity
-&gt; TracedTable trace key writeEntity readEntity
</span><a href="Orville.PostgreSQL.EntityTrace.html#mkTracedTable"><span class="hs-identifier hs-var hs-var">mkTracedTable</span></a></span></span><span> </span><span id="local-6989586621679122473"><span class="annot"><span class="annottext">readEntity -&gt; key
</span><a href="#local-6989586621679122473"><span class="hs-identifier hs-var">getEntityKey</span></a></span></span><span> </span><span id="local-6989586621679122472"><span class="annot"><span class="annottext">TableDefinition (HasKey key) writeEntity readEntity
</span><a href="#local-6989586621679122472"><span class="hs-identifier hs-var">tableDef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-91"></span><span>  </span><span class="annot"><span class="annottext">TracedTable :: forall trace key writeEntity readEntity.
TableDefinition (HasKey key) writeEntity readEntity
-&gt; (readEntity -&gt; key)
-&gt; Constructors (writeEntity -&gt; readEntity -&gt; [trace])
-&gt; Constructors
     (readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace])
-&gt; Constructors (key -&gt; Maybe readEntity -&gt; [trace])
-&gt; TracedTable trace key writeEntity readEntity
</span><a href="Orville.PostgreSQL.EntityTrace.html#TracedTable"><span class="hs-identifier hs-type">TracedTable</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_untracedTableDefinition :: TableDefinition (HasKey key) writeEntity readEntity
</span><a href="Orville.PostgreSQL.EntityTrace.html#_untracedTableDefinition"><span class="hs-identifier hs-var">_untracedTableDefinition</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TableDefinition (HasKey key) writeEntity readEntity
</span><a href="#local-6989586621679122472"><span class="hs-identifier hs-var">tableDef</span></a></span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_getTracedEntityKey :: readEntity -&gt; key
</span><a href="Orville.PostgreSQL.EntityTrace.html#_getTracedEntityKey"><span class="hs-identifier hs-var">_getTracedEntityKey</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">readEntity -&gt; key
</span><a href="#local-6989586621679122473"><span class="hs-identifier hs-var">getEntityKey</span></a></span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_insertTraceConstructors :: Constructors (writeEntity -&gt; readEntity -&gt; [trace])
</span><a href="Orville.PostgreSQL.EntityTrace.html#_insertTraceConstructors"><span class="hs-identifier hs-var">_insertTraceConstructors</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Constructors (writeEntity -&gt; readEntity -&gt; [trace])
forall f. Constructors f
</span><a href="Orville.PostgreSQL.EntityTrace.html#emptyConstructors"><span class="hs-identifier hs-var">emptyConstructors</span></a></span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_updateTraceConstructors :: Constructors
  (readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace])
</span><a href="Orville.PostgreSQL.EntityTrace.html#_updateTraceConstructors"><span class="hs-identifier hs-var">_updateTraceConstructors</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Constructors
  (readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace])
forall f. Constructors f
</span><a href="Orville.PostgreSQL.EntityTrace.html#emptyConstructors"><span class="hs-identifier hs-var">emptyConstructors</span></a></span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_deleteTraceConstructors :: Constructors (key -&gt; Maybe readEntity -&gt; [trace])
</span><a href="Orville.PostgreSQL.EntityTrace.html#_deleteTraceConstructors"><span class="hs-identifier hs-var">_deleteTraceConstructors</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Constructors (key -&gt; Maybe readEntity -&gt; [trace])
forall f. Constructors f
</span><a href="Orville.PostgreSQL.EntityTrace.html#emptyConstructors"><span class="hs-identifier hs-var">emptyConstructors</span></a></span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span class="hs-comment">{- |
  INTERNAL: Construct traces to be recorded by 'insertEntityTraced' based on
  all the constructor callbacks there were added via 'addInsertTrace'
-}</span><span>
</span><span id="line-103"></span><span id="local-6989586621679122645"><span id="local-6989586621679122646"><span id="local-6989586621679122647"><span id="local-6989586621679122648"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#mkInsertTraces"><span class="hs-identifier hs-type">mkInsertTraces</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-104"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TracedTable"><span class="hs-identifier hs-type">TracedTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122648"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122647"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122646"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122645"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-105"></span><span>  </span><span class="annot"><a href="#local-6989586621679122646"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-106"></span><span>  </span><span class="annot"><a href="#local-6989586621679122645"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-107"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679122648"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">]</span></span></span></span></span><span>
</span><span id="line-108"></span><span id="mkInsertTraces"><span class="annot"><span class="annottext">mkInsertTraces :: TracedTable trace key writeEntity readEntity
-&gt; writeEntity -&gt; readEntity -&gt; [trace]
</span><a href="Orville.PostgreSQL.EntityTrace.html#mkInsertTraces"><span class="hs-identifier hs-var hs-var">mkInsertTraces</span></a></span></span><span> </span><span id="local-6989586621679122470"><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122470"><span class="hs-identifier hs-var">tracedTable</span></a></span></span><span> </span><span id="local-6989586621679122469"><span class="annot"><span class="annottext">writeEntity
</span><a href="#local-6989586621679122469"><span class="hs-identifier hs-var">readEntity</span></a></span></span><span> </span><span id="local-6989586621679122468"><span class="annot"><span class="annottext">readEntity
</span><a href="#local-6989586621679122468"><span class="hs-identifier hs-var">writeEntity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-109"></span><span>  </span><span class="annot"><span class="annottext">((writeEntity -&gt; readEntity -&gt; [trace]) -&gt; [trace])
-&gt; Constructors (writeEntity -&gt; readEntity -&gt; [trace]) -&gt; [trace]
forall f a. (f -&gt; [a]) -&gt; Constructors f -&gt; [a]
</span><a href="Orville.PostgreSQL.EntityTrace.html#applyConstructors"><span class="hs-identifier hs-var">applyConstructors</span></a></span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679122467"><span class="annot"><span class="annottext">writeEntity -&gt; readEntity -&gt; [trace]
</span><a href="#local-6989586621679122467"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">writeEntity -&gt; readEntity -&gt; [trace]
</span><a href="#local-6989586621679122467"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">writeEntity
</span><a href="#local-6989586621679122469"><span class="hs-identifier hs-var">readEntity</span></a></span><span> </span><span class="annot"><span class="annottext">readEntity
</span><a href="#local-6989586621679122468"><span class="hs-identifier hs-var">writeEntity</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
-&gt; Constructors (writeEntity -&gt; readEntity -&gt; [trace])
forall trace key writeEntity readEntity.
TracedTable trace key writeEntity readEntity
-&gt; Constructors (writeEntity -&gt; readEntity -&gt; [trace])
</span><a href="Orville.PostgreSQL.EntityTrace.html#_insertTraceConstructors"><span class="hs-identifier hs-var hs-var">_insertTraceConstructors</span></a></span><span> </span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122470"><span class="hs-identifier hs-var">tracedTable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span class="hs-comment">{- |
  INTERNAL: Construct traces to be recorded by 'updateEntityTraced' based on
  all the constructor callbacks there were added via 'addUpdateTrace'
-}</span><span>
</span><span id="line-117"></span><span id="local-6989586621679122629"><span id="local-6989586621679122630"><span id="local-6989586621679122631"><span id="local-6989586621679122632"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#mkUpdateTraces"><span class="hs-identifier hs-type">mkUpdateTraces</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-118"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TracedTable"><span class="hs-identifier hs-type">TracedTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122632"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122631"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122630"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122629"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-119"></span><span>  </span><span class="annot"><a href="#local-6989586621679122629"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-120"></span><span>  </span><span class="annot"><a href="#local-6989586621679122630"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-121"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679122629"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679122632"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">]</span></span></span></span></span><span>
</span><span id="line-123"></span><span id="mkUpdateTraces"><span class="annot"><span class="annottext">mkUpdateTraces :: TracedTable trace key writeEntity readEntity
-&gt; readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace]
</span><a href="Orville.PostgreSQL.EntityTrace.html#mkUpdateTraces"><span class="hs-identifier hs-var hs-var">mkUpdateTraces</span></a></span></span><span> </span><span id="local-6989586621679122465"><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122465"><span class="hs-identifier hs-var">tracedTable</span></a></span></span><span> </span><span id="local-6989586621679122464"><span class="annot"><span class="annottext">readEntity
</span><a href="#local-6989586621679122464"><span class="hs-identifier hs-var">readEntity</span></a></span></span><span> </span><span id="local-6989586621679122463"><span class="annot"><span class="annottext">writeEntity
</span><a href="#local-6989586621679122463"><span class="hs-identifier hs-var">writeEntity</span></a></span></span><span> </span><span id="local-6989586621679122462"><span class="annot"><span class="annottext">Maybe readEntity
</span><a href="#local-6989586621679122462"><span class="hs-identifier hs-var">mbUpdatedEntity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-124"></span><span>  </span><span class="annot"><span class="annottext">((readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace])
 -&gt; [trace])
-&gt; Constructors
     (readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace])
-&gt; [trace]
forall f a. (f -&gt; [a]) -&gt; Constructors f -&gt; [a]
</span><a href="Orville.PostgreSQL.EntityTrace.html#applyConstructors"><span class="hs-identifier hs-var">applyConstructors</span></a></span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679122461"><span class="annot"><span class="annottext">readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace]
</span><a href="#local-6989586621679122461"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace]
</span><a href="#local-6989586621679122461"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">readEntity
</span><a href="#local-6989586621679122464"><span class="hs-identifier hs-var">readEntity</span></a></span><span> </span><span class="annot"><span class="annottext">writeEntity
</span><a href="#local-6989586621679122463"><span class="hs-identifier hs-var">writeEntity</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe readEntity
</span><a href="#local-6989586621679122462"><span class="hs-identifier hs-var">mbUpdatedEntity</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
-&gt; Constructors
     (readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace])
forall trace key writeEntity readEntity.
TracedTable trace key writeEntity readEntity
-&gt; Constructors
     (readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace])
</span><a href="Orville.PostgreSQL.EntityTrace.html#_updateTraceConstructors"><span class="hs-identifier hs-var hs-var">_updateTraceConstructors</span></a></span><span> </span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122465"><span class="hs-identifier hs-var">tracedTable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span class="hs-comment">{- |
  INTERNAL: Construct traces to be recorded by 'deleteEntityTraced' based on
  all the constructor callbacks that were added via 'addDeleteTrace'
-}</span><span>
</span><span id="line-132"></span><span id="local-6989586621679122615"><span id="local-6989586621679122616"><span id="local-6989586621679122617"><span id="local-6989586621679122618"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#mkDeleteTraces"><span class="hs-identifier hs-type">mkDeleteTraces</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-133"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TracedTable"><span class="hs-identifier hs-type">TracedTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122618"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122617"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122616"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122615"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-134"></span><span>  </span><span class="annot"><a href="#local-6989586621679122617"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-135"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679122615"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679122618"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">]</span></span></span></span></span><span>
</span><span id="line-137"></span><span id="mkDeleteTraces"><span class="annot"><span class="annottext">mkDeleteTraces :: TracedTable trace key writeEntity readEntity
-&gt; key -&gt; Maybe readEntity -&gt; [trace]
</span><a href="Orville.PostgreSQL.EntityTrace.html#mkDeleteTraces"><span class="hs-identifier hs-var hs-var">mkDeleteTraces</span></a></span></span><span> </span><span id="local-6989586621679122459"><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122459"><span class="hs-identifier hs-var">tracedTable</span></a></span></span><span> </span><span id="local-6989586621679122458"><span class="annot"><span class="annottext">key
</span><a href="#local-6989586621679122458"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span id="local-6989586621679122457"><span class="annot"><span class="annottext">Maybe readEntity
</span><a href="#local-6989586621679122457"><span class="hs-identifier hs-var">mbDeletedEntity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-138"></span><span>  </span><span class="annot"><span class="annottext">((key -&gt; Maybe readEntity -&gt; [trace]) -&gt; [trace])
-&gt; Constructors (key -&gt; Maybe readEntity -&gt; [trace]) -&gt; [trace]
forall f a. (f -&gt; [a]) -&gt; Constructors f -&gt; [a]
</span><a href="Orville.PostgreSQL.EntityTrace.html#applyConstructors"><span class="hs-identifier hs-var">applyConstructors</span></a></span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679122456"><span class="annot"><span class="annottext">key -&gt; Maybe readEntity -&gt; [trace]
</span><a href="#local-6989586621679122456"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">key -&gt; Maybe readEntity -&gt; [trace]
</span><a href="#local-6989586621679122456"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">key
</span><a href="#local-6989586621679122458"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe readEntity
</span><a href="#local-6989586621679122457"><span class="hs-identifier hs-var">mbDeletedEntity</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
-&gt; Constructors (key -&gt; Maybe readEntity -&gt; [trace])
forall trace key writeEntity readEntity.
TracedTable trace key writeEntity readEntity
-&gt; Constructors (key -&gt; Maybe readEntity -&gt; [trace])
</span><a href="Orville.PostgreSQL.EntityTrace.html#_deleteTraceConstructors"><span class="hs-identifier hs-var hs-var">_deleteTraceConstructors</span></a></span><span> </span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122459"><span class="hs-identifier hs-var">tracedTable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="hs-comment">{- |
  Returns the 'O.TableDefinition' underlying a 'TracedTable'. You can use this
  to get access to the table definiton to use the regular untraced Orville
  functions without having to keep a separate reference to the untraced table
  around.
-}</span><span>
</span><span id="line-148"></span><span id="local-6989586621679122452"><span id="local-6989586621679122453"><span id="local-6989586621679122454"><span id="local-6989586621679122455"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#untracedTableDefinition"><span class="hs-identifier hs-type">untracedTableDefinition</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-149"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TracedTable"><span class="hs-identifier hs-type">TracedTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122455"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122454"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122453"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122452"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-150"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Internal.TableDefinition.html#TableDefinition"><span class="hs-identifier hs-type">O.TableDefinition</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.Internal.TableDefinition.html#HasKey"><span class="hs-identifier hs-type">O.HasKey</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122454"><span class="hs-identifier hs-type">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679122453"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122452"><span class="hs-identifier hs-type">readEntity</span></a></span></span></span></span></span><span>
</span><span id="line-151"></span><span id="untracedTableDefinition"><span class="annot"><span class="annottext">untracedTableDefinition :: TracedTable trace key writeEntity readEntity
-&gt; TableDefinition (HasKey key) writeEntity readEntity
</span><a href="Orville.PostgreSQL.EntityTrace.html#untracedTableDefinition"><span class="hs-identifier hs-var hs-var">untracedTableDefinition</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-152"></span><span>  </span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
-&gt; TableDefinition (HasKey key) writeEntity readEntity
forall trace key writeEntity readEntity.
TracedTable trace key writeEntity readEntity
-&gt; TableDefinition (HasKey key) writeEntity readEntity
</span><a href="Orville.PostgreSQL.EntityTrace.html#_untracedTableDefinition"><span class="hs-identifier hs-var hs-var">_untracedTableDefinition</span></a></span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span class="hs-comment">{- |
  Adds a callback that will be used during 'insertEntityTraced' to build the
  @trace@ items to be recorded for that insert. The trace building function
  will be passed the @writeEntity@ given to 'insertEntityTraced' as well as
  the @readEntity@ that is returned as a result of the insert.
-}</span><span>
</span><span id="line-160"></span><span id="local-6989586621679122448"><span id="local-6989586621679122449"><span id="local-6989586621679122450"><span id="local-6989586621679122451"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#addInsertTrace"><span class="hs-identifier hs-type">addInsertTrace</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-161"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679122451"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679122450"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679122449"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-162"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TracedTable"><span class="hs-identifier hs-type">TracedTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122449"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122448"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122451"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122450"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-163"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TracedTable"><span class="hs-identifier hs-type">TracedTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122449"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122448"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122451"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122450"><span class="hs-identifier hs-type">readEntity</span></a></span></span></span></span></span><span>
</span><span id="line-164"></span><span id="addInsertTrace"><span class="annot"><span class="annottext">addInsertTrace :: (writeEntity -&gt; readEntity -&gt; [trace])
-&gt; TracedTable trace key writeEntity readEntity
-&gt; TracedTable trace key writeEntity readEntity
</span><a href="Orville.PostgreSQL.EntityTrace.html#addInsertTrace"><span class="hs-identifier hs-var hs-var">addInsertTrace</span></a></span></span><span> </span><span id="local-6989586621679122447"><span class="annot"><span class="annottext">writeEntity -&gt; readEntity -&gt; [trace]
</span><a href="#local-6989586621679122447"><span class="hs-identifier hs-var">mkTraces</span></a></span></span><span> </span><span id="local-6989586621679122446"><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122446"><span class="hs-identifier hs-var">tracedTable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-165"></span><span>  </span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122446"><span class="hs-identifier hs-var">tracedTable</span></a></span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_insertTraceConstructors :: Constructors (writeEntity -&gt; readEntity -&gt; [trace])
</span><a href="Orville.PostgreSQL.EntityTrace.html#_insertTraceConstructors"><span class="hs-identifier hs-var">_insertTraceConstructors</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(writeEntity -&gt; readEntity -&gt; [trace])
-&gt; Constructors (writeEntity -&gt; readEntity -&gt; [trace])
-&gt; Constructors (writeEntity -&gt; readEntity -&gt; [trace])
forall f. f -&gt; Constructors f -&gt; Constructors f
</span><a href="Orville.PostgreSQL.EntityTrace.html#addConstructor"><span class="hs-identifier hs-var">addConstructor</span></a></span><span> </span><span class="annot"><span class="annottext">writeEntity -&gt; readEntity -&gt; [trace]
</span><a href="#local-6989586621679122447"><span class="hs-identifier hs-var">mkTraces</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
-&gt; Constructors (writeEntity -&gt; readEntity -&gt; [trace])
forall trace key writeEntity readEntity.
TracedTable trace key writeEntity readEntity
-&gt; Constructors (writeEntity -&gt; readEntity -&gt; [trace])
</span><a href="Orville.PostgreSQL.EntityTrace.html#_insertTraceConstructors"><span class="hs-identifier hs-var hs-var">_insertTraceConstructors</span></a></span><span> </span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122446"><span class="hs-identifier hs-var">tracedTable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span class="hs-comment">{- |
  Adds a callback that will be used during 'updateEntityTraced' to build the
  @trace@ items to be recorded for that update. The trace building function
  will be passed the @readEntity@ and @writeEntity@ that were given to
  'updateEntityTraced' as well as the any @readEntity@ that is returned as a
  result of the insert. If the update matches no rows in the database, 'Nothing'
  will be passed as the last argument to the trace building function.
-}</span><span>
</span><span id="line-177"></span><span id="local-6989586621679122442"><span id="local-6989586621679122443"><span id="local-6989586621679122444"><span id="local-6989586621679122445"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#addUpdateTrace"><span class="hs-identifier hs-type">addUpdateTrace</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-178"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679122445"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679122444"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679122445"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679122443"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-179"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TracedTable"><span class="hs-identifier hs-type">TracedTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122443"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122442"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122444"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122445"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-180"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TracedTable"><span class="hs-identifier hs-type">TracedTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122443"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122442"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122444"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122445"><span class="hs-identifier hs-type">readEntity</span></a></span></span></span></span></span><span>
</span><span id="line-181"></span><span id="addUpdateTrace"><span class="annot"><span class="annottext">addUpdateTrace :: (readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace])
-&gt; TracedTable trace key writeEntity readEntity
-&gt; TracedTable trace key writeEntity readEntity
</span><a href="Orville.PostgreSQL.EntityTrace.html#addUpdateTrace"><span class="hs-identifier hs-var hs-var">addUpdateTrace</span></a></span></span><span> </span><span id="local-6989586621679122441"><span class="annot"><span class="annottext">readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace]
</span><a href="#local-6989586621679122441"><span class="hs-identifier hs-var">mkTraces</span></a></span></span><span> </span><span id="local-6989586621679122440"><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122440"><span class="hs-identifier hs-var">tracedTable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-182"></span><span>  </span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122440"><span class="hs-identifier hs-var">tracedTable</span></a></span><span>
</span><span id="line-183"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_updateTraceConstructors :: Constructors
  (readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace])
</span><a href="Orville.PostgreSQL.EntityTrace.html#_updateTraceConstructors"><span class="hs-identifier hs-var">_updateTraceConstructors</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace])
-&gt; Constructors
     (readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace])
-&gt; Constructors
     (readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace])
forall f. f -&gt; Constructors f -&gt; Constructors f
</span><a href="Orville.PostgreSQL.EntityTrace.html#addConstructor"><span class="hs-identifier hs-var">addConstructor</span></a></span><span> </span><span class="annot"><span class="annottext">readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace]
</span><a href="#local-6989586621679122441"><span class="hs-identifier hs-var">mkTraces</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
-&gt; Constructors
     (readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace])
forall trace key writeEntity readEntity.
TracedTable trace key writeEntity readEntity
-&gt; Constructors
     (readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace])
</span><a href="Orville.PostgreSQL.EntityTrace.html#_updateTraceConstructors"><span class="hs-identifier hs-var hs-var">_updateTraceConstructors</span></a></span><span> </span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122440"><span class="hs-identifier hs-var">tracedTable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="hs-comment">{- |
  Adds a callback that will be used during 'deleteEntityTraced' to build the
  @trace@ items to be recorded for that update. The trace building function
  will be passed the @key@ that sa given to 'deleteEntityTraced' as well as the
  any @readEntity@ that is returned as a result of the delete. If the delete
  matches no rows in the database, 'Nothing' will be passed as the last
  argument to the trace building function.
-}</span><span>
</span><span id="line-194"></span><span id="local-6989586621679122436"><span id="local-6989586621679122437"><span id="local-6989586621679122438"><span id="local-6989586621679122439"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#addDeleteTrace"><span class="hs-identifier hs-type">addDeleteTrace</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679122439"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679122438"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679122437"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-196"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TracedTable"><span class="hs-identifier hs-type">TracedTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122437"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122439"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122436"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122438"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-197"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TracedTable"><span class="hs-identifier hs-type">TracedTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122437"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122439"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122436"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122438"><span class="hs-identifier hs-type">readEntity</span></a></span></span></span></span></span><span>
</span><span id="line-198"></span><span id="addDeleteTrace"><span class="annot"><span class="annottext">addDeleteTrace :: (key -&gt; Maybe readEntity -&gt; [trace])
-&gt; TracedTable trace key writeEntity readEntity
-&gt; TracedTable trace key writeEntity readEntity
</span><a href="Orville.PostgreSQL.EntityTrace.html#addDeleteTrace"><span class="hs-identifier hs-var hs-var">addDeleteTrace</span></a></span></span><span> </span><span id="local-6989586621679122435"><span class="annot"><span class="annottext">key -&gt; Maybe readEntity -&gt; [trace]
</span><a href="#local-6989586621679122435"><span class="hs-identifier hs-var">mkTraces</span></a></span></span><span> </span><span id="local-6989586621679122434"><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122434"><span class="hs-identifier hs-var">tracedTable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-199"></span><span>  </span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122434"><span class="hs-identifier hs-var">tracedTable</span></a></span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_deleteTraceConstructors :: Constructors (key -&gt; Maybe readEntity -&gt; [trace])
</span><a href="Orville.PostgreSQL.EntityTrace.html#_deleteTraceConstructors"><span class="hs-identifier hs-var">_deleteTraceConstructors</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(key -&gt; Maybe readEntity -&gt; [trace])
-&gt; Constructors (key -&gt; Maybe readEntity -&gt; [trace])
-&gt; Constructors (key -&gt; Maybe readEntity -&gt; [trace])
forall f. f -&gt; Constructors f -&gt; Constructors f
</span><a href="Orville.PostgreSQL.EntityTrace.html#addConstructor"><span class="hs-identifier hs-var">addConstructor</span></a></span><span> </span><span class="annot"><span class="annottext">key -&gt; Maybe readEntity -&gt; [trace]
</span><a href="#local-6989586621679122435"><span class="hs-identifier hs-var">mkTraces</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
-&gt; Constructors (key -&gt; Maybe readEntity -&gt; [trace])
forall trace key writeEntity readEntity.
TracedTable trace key writeEntity readEntity
-&gt; Constructors (key -&gt; Maybe readEntity -&gt; [trace])
</span><a href="Orville.PostgreSQL.EntityTrace.html#_deleteTraceConstructors"><span class="hs-identifier hs-var hs-var">_deleteTraceConstructors</span></a></span><span> </span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122434"><span class="hs-identifier hs-var">tracedTable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span class="hs-comment">{- |
  Inserts an entity into the database via 'O.insertAndReturnEntity', then records
  any traces returned by the 'addInsertTrace' callbacks on the 'TracedTable'
  via 'recordTraces'.

  See 'runEntityTraceT' for a stock way to run actions using these trace
  operations and get access to the traces that are recorded.
-}</span><span>
</span><span id="line-211"></span><span id="local-6989586621679122429"><span id="local-6989586621679122430"><span id="local-6989586621679122431"><span id="local-6989586621679122432"><span id="local-6989586621679122433"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#insertEntityTraced"><span class="hs-identifier hs-type">insertEntityTraced</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-212"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#MonadEntityTrace"><span class="hs-identifier hs-type">MonadEntityTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122433"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122432"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-213"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TracedTable"><span class="hs-identifier hs-type">TracedTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122433"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122431"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122430"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122429"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-214"></span><span>  </span><span class="annot"><a href="#local-6989586621679122430"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-215"></span><span>  </span><span class="annot"><a href="#local-6989586621679122432"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122429"><span class="hs-identifier hs-type">readEntity</span></a></span></span></span></span></span></span><span>
</span><span id="line-216"></span><span id="insertEntityTraced"><span class="annot"><span class="annottext">insertEntityTraced :: TracedTable trace key writeEntity readEntity
-&gt; writeEntity -&gt; m readEntity
</span><a href="Orville.PostgreSQL.EntityTrace.html#insertEntityTraced"><span class="hs-identifier hs-var hs-var">insertEntityTraced</span></a></span></span><span> </span><span id="local-6989586621679122428"><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122428"><span class="hs-identifier hs-var">tracedTable</span></a></span></span><span> </span><span id="local-6989586621679122427"><span class="annot"><span class="annottext">writeEntity
</span><a href="#local-6989586621679122427"><span class="hs-identifier hs-var">writeEntity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-217"></span><span>  </span><span id="local-6989586621679122426"><span class="annot"><span class="annottext">readEntity
</span><a href="#local-6989586621679122426"><span class="hs-identifier hs-var">readEntity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-218"></span><span>    </span><span class="annot"><span class="annottext">(forall (n :: * -&gt; *). MonadOrville n =&gt; n readEntity)
-&gt; m readEntity
forall trace (m :: * -&gt; *) a.
MonadEntityTrace trace m =&gt;
(forall (n :: * -&gt; *). MonadOrville n =&gt; n a) -&gt; m a
</span><a href="Orville.PostgreSQL.EntityTrace.html#liftOrvilleUntraced"><span class="hs-identifier hs-var">liftOrvilleUntraced</span></a></span><span> </span><span class="annot"><span class="annottext">((forall (n :: * -&gt; *). MonadOrville n =&gt; n readEntity)
 -&gt; m readEntity)
-&gt; (forall (n :: * -&gt; *). MonadOrville n =&gt; n readEntity)
-&gt; m readEntity
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-219"></span><span>      </span><span class="annot"><span class="annottext">TableDefinition (HasKey key) writeEntity readEntity
-&gt; writeEntity -&gt; n readEntity
forall (m :: * -&gt; *) key writeEntity readEntity.
MonadOrville m =&gt;
TableDefinition key writeEntity readEntity
-&gt; writeEntity -&gt; m readEntity
</span><a href="Orville.PostgreSQL.Internal.EntityOperations.html#insertAndReturnEntity"><span class="hs-identifier hs-var">O.insertAndReturnEntity</span></a></span><span>
</span><span id="line-220"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
-&gt; TableDefinition (HasKey key) writeEntity readEntity
forall trace key writeEntity readEntity.
TracedTable trace key writeEntity readEntity
-&gt; TableDefinition (HasKey key) writeEntity readEntity
</span><a href="Orville.PostgreSQL.EntityTrace.html#_untracedTableDefinition"><span class="hs-identifier hs-var hs-var">_untracedTableDefinition</span></a></span><span> </span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122428"><span class="hs-identifier hs-var">tracedTable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>        </span><span class="annot"><span class="annottext">writeEntity
</span><a href="#local-6989586621679122427"><span class="hs-identifier hs-var">writeEntity</span></a></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span>  </span><span class="annot"><span class="annottext">[trace] -&gt; m ()
forall trace (m :: * -&gt; *).
MonadEntityTrace trace m =&gt;
[trace] -&gt; m ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#recordTraces"><span class="hs-identifier hs-var">recordTraces</span></a></span><span> </span><span class="annot"><span class="annottext">([trace] -&gt; m ()) -&gt; [trace] -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
-&gt; writeEntity -&gt; readEntity -&gt; [trace]
forall trace key writeEntity readEntity.
TracedTable trace key writeEntity readEntity
-&gt; writeEntity -&gt; readEntity -&gt; [trace]
</span><a href="Orville.PostgreSQL.EntityTrace.html#mkInsertTraces"><span class="hs-identifier hs-var">mkInsertTraces</span></a></span><span> </span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122428"><span class="hs-identifier hs-var">tracedTable</span></a></span><span> </span><span class="annot"><span class="annottext">writeEntity
</span><a href="#local-6989586621679122427"><span class="hs-identifier hs-var">writeEntity</span></a></span><span> </span><span class="annot"><span class="annottext">readEntity
</span><a href="#local-6989586621679122426"><span class="hs-identifier hs-var">readEntity</span></a></span><span>
</span><span id="line-224"></span><span>  </span><span class="annot"><span class="annottext">readEntity -&gt; m readEntity
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">readEntity
</span><a href="#local-6989586621679122426"><span class="hs-identifier hs-var">readEntity</span></a></span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span class="hs-comment">{- |
  Updates an entity in the database via 'O.updateAndReturnEntity', then records
  any traces returned by the 'addUpdateTrace' callbacks on the 'TracedTable'
  via 'recordTraces'.

  See 'runEntityTraceT' for a stock way to run actions using these trace
  operations and get access to the traces that are recorded.
-}</span><span>
</span><span id="line-234"></span><span id="local-6989586621679122420"><span id="local-6989586621679122421"><span id="local-6989586621679122422"><span id="local-6989586621679122423"><span id="local-6989586621679122424"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#updateEntityTraced"><span class="hs-identifier hs-type">updateEntityTraced</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-235"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#MonadEntityTrace"><span class="hs-identifier hs-type">MonadEntityTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122424"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122423"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-236"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TracedTable"><span class="hs-identifier hs-type">TracedTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122424"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122422"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122421"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122420"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-237"></span><span>  </span><span class="annot"><a href="#local-6989586621679122420"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-238"></span><span>  </span><span class="annot"><a href="#local-6989586621679122421"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-239"></span><span>  </span><span class="annot"><a href="#local-6989586621679122423"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-240"></span><span id="updateEntityTraced"><span class="annot"><span class="annottext">updateEntityTraced :: TracedTable trace key writeEntity readEntity
-&gt; readEntity -&gt; writeEntity -&gt; m ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#updateEntityTraced"><span class="hs-identifier hs-var hs-var">updateEntityTraced</span></a></span></span><span> </span><span id="local-6989586621679122419"><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122419"><span class="hs-identifier hs-var">tracedTable</span></a></span></span><span> </span><span id="local-6989586621679122418"><span class="annot"><span class="annottext">readEntity
</span><a href="#local-6989586621679122418"><span class="hs-identifier hs-var">oldEntity</span></a></span></span><span> </span><span id="local-6989586621679122417"><span class="annot"><span class="annottext">writeEntity
</span><a href="#local-6989586621679122417"><span class="hs-identifier hs-var">newEntity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-241"></span><span>  </span><span id="local-6989586621679122416"><span class="annot"><span class="annottext">Maybe readEntity
</span><a href="#local-6989586621679122416"><span class="hs-identifier hs-var">updatedEntity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-242"></span><span>    </span><span class="annot"><span class="annottext">(forall (n :: * -&gt; *). MonadOrville n =&gt; n (Maybe readEntity))
-&gt; m (Maybe readEntity)
forall trace (m :: * -&gt; *) a.
MonadEntityTrace trace m =&gt;
(forall (n :: * -&gt; *). MonadOrville n =&gt; n a) -&gt; m a
</span><a href="Orville.PostgreSQL.EntityTrace.html#liftOrvilleUntraced"><span class="hs-identifier hs-var">liftOrvilleUntraced</span></a></span><span> </span><span class="annot"><span class="annottext">((forall (n :: * -&gt; *). MonadOrville n =&gt; n (Maybe readEntity))
 -&gt; m (Maybe readEntity))
-&gt; (forall (n :: * -&gt; *). MonadOrville n =&gt; n (Maybe readEntity))
-&gt; m (Maybe readEntity)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-243"></span><span>      </span><span class="annot"><span class="annottext">TableDefinition (HasKey key) writeEntity readEntity
-&gt; key -&gt; writeEntity -&gt; n (Maybe readEntity)
forall (m :: * -&gt; *) key writeEntity readEntity.
MonadOrville m =&gt;
TableDefinition (HasKey key) writeEntity readEntity
-&gt; key -&gt; writeEntity -&gt; m (Maybe readEntity)
</span><a href="Orville.PostgreSQL.Internal.EntityOperations.html#updateAndReturnEntity"><span class="hs-identifier hs-var">O.updateAndReturnEntity</span></a></span><span>
</span><span id="line-244"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
-&gt; TableDefinition (HasKey key) writeEntity readEntity
forall trace key writeEntity readEntity.
TracedTable trace key writeEntity readEntity
-&gt; TableDefinition (HasKey key) writeEntity readEntity
</span><a href="Orville.PostgreSQL.EntityTrace.html#_untracedTableDefinition"><span class="hs-identifier hs-var hs-var">_untracedTableDefinition</span></a></span><span> </span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122419"><span class="hs-identifier hs-var">tracedTable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity -&gt; readEntity -&gt; key
forall trace key writeEntity readEntity.
TracedTable trace key writeEntity readEntity -&gt; readEntity -&gt; key
</span><a href="Orville.PostgreSQL.EntityTrace.html#_getTracedEntityKey"><span class="hs-identifier hs-var hs-var">_getTracedEntityKey</span></a></span><span> </span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122419"><span class="hs-identifier hs-var">tracedTable</span></a></span><span> </span><span class="annot"><span class="annottext">readEntity
</span><a href="#local-6989586621679122418"><span class="hs-identifier hs-var">oldEntity</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>        </span><span class="annot"><span class="annottext">writeEntity
</span><a href="#local-6989586621679122417"><span class="hs-identifier hs-var">newEntity</span></a></span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span>  </span><span class="annot"><span class="annottext">[trace] -&gt; m ()
forall trace (m :: * -&gt; *).
MonadEntityTrace trace m =&gt;
[trace] -&gt; m ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#recordTraces"><span class="hs-identifier hs-var">recordTraces</span></a></span><span> </span><span class="annot"><span class="annottext">([trace] -&gt; m ()) -&gt; [trace] -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
-&gt; readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace]
forall trace key writeEntity readEntity.
TracedTable trace key writeEntity readEntity
-&gt; readEntity -&gt; writeEntity -&gt; Maybe readEntity -&gt; [trace]
</span><a href="Orville.PostgreSQL.EntityTrace.html#mkUpdateTraces"><span class="hs-identifier hs-var">mkUpdateTraces</span></a></span><span> </span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122419"><span class="hs-identifier hs-var">tracedTable</span></a></span><span> </span><span class="annot"><span class="annottext">readEntity
</span><a href="#local-6989586621679122418"><span class="hs-identifier hs-var">oldEntity</span></a></span><span> </span><span class="annot"><span class="annottext">writeEntity
</span><a href="#local-6989586621679122417"><span class="hs-identifier hs-var">newEntity</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe readEntity
</span><a href="#local-6989586621679122416"><span class="hs-identifier hs-var">updatedEntity</span></a></span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span class="hs-comment">{- |
  Updates an entity in the database via 'O.deleteAndReturnEntity', then records
  any traces returned by the 'addDeleteTrace' callbacks on the 'TracedTable'
  via 'recordTraces'.

  See 'runEntityTraceT' for a stock way to run actions using these trace
  operations and get access to the traces that are recorded.
-}</span><span>
</span><span id="line-258"></span><span id="local-6989586621679122410"><span id="local-6989586621679122411"><span id="local-6989586621679122412"><span id="local-6989586621679122413"><span id="local-6989586621679122414"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#deleteEntityTraced"><span class="hs-identifier hs-type">deleteEntityTraced</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#MonadEntityTrace"><span class="hs-identifier hs-type">MonadEntityTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122414"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122413"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-260"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TracedTable"><span class="hs-identifier hs-type">TracedTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122414"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122412"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122411"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122410"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-261"></span><span>  </span><span class="annot"><a href="#local-6989586621679122412"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-262"></span><span>  </span><span class="annot"><a href="#local-6989586621679122413"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-263"></span><span id="deleteEntityTraced"><span class="annot"><span class="annottext">deleteEntityTraced :: TracedTable trace key writeEntity readEntity -&gt; key -&gt; m ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#deleteEntityTraced"><span class="hs-identifier hs-var hs-var">deleteEntityTraced</span></a></span></span><span> </span><span id="local-6989586621679122409"><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122409"><span class="hs-identifier hs-var">tracedTable</span></a></span></span><span> </span><span id="local-6989586621679122408"><span class="annot"><span class="annottext">key
</span><a href="#local-6989586621679122408"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-264"></span><span>  </span><span id="local-6989586621679122407"><span class="annot"><span class="annottext">Maybe readEntity
</span><a href="#local-6989586621679122407"><span class="hs-identifier hs-var">readEntity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-265"></span><span>    </span><span class="annot"><span class="annottext">(forall (n :: * -&gt; *). MonadOrville n =&gt; n (Maybe readEntity))
-&gt; m (Maybe readEntity)
forall trace (m :: * -&gt; *) a.
MonadEntityTrace trace m =&gt;
(forall (n :: * -&gt; *). MonadOrville n =&gt; n a) -&gt; m a
</span><a href="Orville.PostgreSQL.EntityTrace.html#liftOrvilleUntraced"><span class="hs-identifier hs-var">liftOrvilleUntraced</span></a></span><span> </span><span class="annot"><span class="annottext">((forall (n :: * -&gt; *). MonadOrville n =&gt; n (Maybe readEntity))
 -&gt; m (Maybe readEntity))
-&gt; (forall (n :: * -&gt; *). MonadOrville n =&gt; n (Maybe readEntity))
-&gt; m (Maybe readEntity)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-266"></span><span>      </span><span class="annot"><span class="annottext">TableDefinition (HasKey key) writeEntity readEntity
-&gt; key -&gt; n (Maybe readEntity)
forall (m :: * -&gt; *) key writeEntity readEntity.
MonadOrville m =&gt;
TableDefinition (HasKey key) writeEntity readEntity
-&gt; key -&gt; m (Maybe readEntity)
</span><a href="Orville.PostgreSQL.Internal.EntityOperations.html#deleteAndReturnEntity"><span class="hs-identifier hs-var">O.deleteAndReturnEntity</span></a></span><span>
</span><span id="line-267"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
-&gt; TableDefinition (HasKey key) writeEntity readEntity
forall trace key writeEntity readEntity.
TracedTable trace key writeEntity readEntity
-&gt; TableDefinition (HasKey key) writeEntity readEntity
</span><a href="Orville.PostgreSQL.EntityTrace.html#_untracedTableDefinition"><span class="hs-identifier hs-var hs-var">_untracedTableDefinition</span></a></span><span> </span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122409"><span class="hs-identifier hs-var">tracedTable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>        </span><span class="annot"><span class="annottext">key
</span><a href="#local-6989586621679122408"><span class="hs-identifier hs-var">key</span></a></span><span>
</span><span id="line-269"></span><span>
</span><span id="line-270"></span><span>  </span><span class="annot"><span class="annottext">[trace] -&gt; m ()
forall trace (m :: * -&gt; *).
MonadEntityTrace trace m =&gt;
[trace] -&gt; m ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#recordTraces"><span class="hs-identifier hs-var">recordTraces</span></a></span><span> </span><span class="annot"><span class="annottext">([trace] -&gt; m ()) -&gt; [trace] -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
-&gt; key -&gt; Maybe readEntity -&gt; [trace]
forall trace key writeEntity readEntity.
TracedTable trace key writeEntity readEntity
-&gt; key -&gt; Maybe readEntity -&gt; [trace]
</span><a href="Orville.PostgreSQL.EntityTrace.html#mkDeleteTraces"><span class="hs-identifier hs-var">mkDeleteTraces</span></a></span><span> </span><span class="annot"><span class="annottext">TracedTable trace key writeEntity readEntity
</span><a href="#local-6989586621679122409"><span class="hs-identifier hs-var">tracedTable</span></a></span><span> </span><span class="annot"><span class="annottext">key
</span><a href="#local-6989586621679122408"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe readEntity
</span><a href="#local-6989586621679122407"><span class="hs-identifier hs-var">readEntity</span></a></span><span>
</span><span id="line-271"></span><span>
</span><span id="line-272"></span><span class="hs-comment">{- |
  An 'EntityTraceState' is created by 'runEntityTraceT' to keep track of
  the state of traces that are to be returned when the function finishes.
-}</span><span>
</span><span id="line-276"></span><span class="hs-keyword">newtype</span><span> </span><span id="EntityTraceState"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceState"><span class="hs-identifier hs-var">EntityTraceState</span></a></span></span><span> </span><span id="local-6989586621679122581"><span class="annot"><a href="#local-6989586621679122581"><span class="hs-identifier hs-type">trace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="EntityTraceState"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceState"><span class="hs-identifier hs-var">EntityTraceState</span></a></span></span><span>
</span><span id="line-277"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_entityTraceStateRef"><span class="annot"><span class="annottext">EntityTraceState trace -&gt; IORef (RecordedTraces trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#_entityTraceStateRef"><span class="hs-identifier hs-var hs-var">_entityTraceStateRef</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#RecordedTraces"><span class="hs-identifier hs-type">RecordedTraces</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122581"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-278"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span class="hs-comment">{- |
  INTERNAL: The 'RecordedTraces' structure stores all the data necessary to
  keep the list of traces to be returned by 'runEntityTraceT' in sync with the
  state of committed and rolled-back transactions that happen at the database
  level, including savepoints. The 'EntityTraceState' keeps track of the
  stricture in an 'IORef' that is modified over the life of the action that is
  run by 'runEntityTraceT'
-}</span><span>
</span><span id="line-288"></span><span class="hs-keyword">data</span><span> </span><span id="RecordedTraces"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#RecordedTraces"><span class="hs-identifier hs-var">RecordedTraces</span></a></span></span><span> </span><span id="local-6989586621679122589"><span class="annot"><a href="#local-6989586621679122589"><span class="hs-identifier hs-type">trace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RecordedTraces"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#RecordedTraces"><span class="hs-identifier hs-var">RecordedTraces</span></a></span></span><span>
</span><span id="line-289"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="committedTracesDList"><span class="annot"><span class="annottext">RecordedTraces trace -&gt; DList trace
</span><a href="Orville.PostgreSQL.EntityTrace.html#committedTracesDList"><span class="hs-identifier hs-var hs-var">committedTracesDList</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DList.DList</span></span><span> </span><span class="annot"><a href="#local-6989586621679122589"><span class="hs-identifier hs-type">trace</span></a></span><span>
</span><span id="line-290"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="currentTransactionStack"><span class="annot"><span class="annottext">RecordedTraces trace -&gt; Maybe (TransactionStack trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#currentTransactionStack"><span class="hs-identifier hs-var hs-var">currentTransactionStack</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TransactionStack"><span class="hs-identifier hs-type">TransactionStack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122589"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span class="hs-comment">{- |
  INTERNAL: Tracks the state of any traces that occur while a transaction is
  open. These are kept in a stack so that savepoints can be created, released
  and rolled-back in sync with any `O.withTransaction` operations that occur
  during 'runEntityTraceT'.
-}</span><span>
</span><span id="line-299"></span><span class="hs-keyword">data</span><span> </span><span id="TransactionStack"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TransactionStack"><span class="hs-identifier hs-var">TransactionStack</span></a></span></span><span> </span><span id="local-6989586621679122602"><span class="annot"><a href="#local-6989586621679122602"><span class="hs-identifier hs-type">trace</span></a></span></span><span>
</span><span id="line-300"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="TransactionOpened"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TransactionOpened"><span class="hs-identifier hs-var">TransactionOpened</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DList.DList</span></span><span> </span><span class="annot"><a href="#local-6989586621679122602"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-301"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="SavepointCreated"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#SavepointCreated"><span class="hs-identifier hs-var">SavepointCreated</span></a></span></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#Savepoint"><span class="hs-identifier hs-type">O.Savepoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DList.DList</span></span><span> </span><span class="annot"><a href="#local-6989586621679122602"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TransactionStack"><span class="hs-identifier hs-type">TransactionStack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122602"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-302"></span><span>
</span><span id="line-303"></span><span class="hs-comment">{- |
  INTERNAL: Assembles all the traces for the 'TransactionStack' into a 'DList'
  in the order in which they originally occurred
-}</span><span>
</span><span id="line-307"></span><span id="local-6989586621679122605"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#allTransactionStackTraces"><span class="hs-identifier hs-type">allTransactionStackTraces</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TransactionStack"><span class="hs-identifier hs-type">TransactionStack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122605"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DList.DList</span></span><span> </span><span class="annot"><a href="#local-6989586621679122605"><span class="hs-identifier hs-type">trace</span></a></span></span><span>
</span><span id="line-308"></span><span id="allTransactionStackTraces"><span class="annot"><span class="annottext">allTransactionStackTraces :: TransactionStack trace -&gt; DList trace
</span><a href="Orville.PostgreSQL.EntityTrace.html#allTransactionStackTraces"><span class="hs-identifier hs-var hs-var">allTransactionStackTraces</span></a></span></span><span> </span><span id="local-6989586621679122397"><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122397"><span class="hs-identifier hs-var">stack</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-309"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122397"><span class="hs-identifier hs-var">stack</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-310"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TransactionOpened"><span class="hs-identifier hs-type">TransactionOpened</span></a></span><span> </span><span id="local-6989586621679122396"><span class="annot"><span class="annottext">DList trace
</span><a href="#local-6989586621679122396"><span class="hs-identifier hs-var">traces</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-311"></span><span>      </span><span class="annot"><span class="annottext">DList trace
</span><a href="#local-6989586621679122396"><span class="hs-identifier hs-var">traces</span></a></span><span>
</span><span id="line-312"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#SavepointCreated"><span class="hs-identifier hs-type">SavepointCreated</span></a></span><span> </span><span class="annot"><span class="annottext">Savepoint
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679122395"><span class="annot"><span class="annottext">DList trace
</span><a href="#local-6989586621679122395"><span class="hs-identifier hs-var">traces</span></a></span></span><span> </span><span id="local-6989586621679122394"><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122394"><span class="hs-identifier hs-var">remainingStack</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-313"></span><span>      </span><span class="annot"><span class="annottext">TransactionStack trace -&gt; DList trace
forall trace. TransactionStack trace -&gt; DList trace
</span><a href="Orville.PostgreSQL.EntityTrace.html#allTransactionStackTraces"><span class="hs-identifier hs-var">allTransactionStackTraces</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122394"><span class="hs-identifier hs-var">remainingStack</span></a></span><span> </span><span class="annot"><span class="annottext">DList trace -&gt; DList trace -&gt; DList trace
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">DList trace
</span><a href="#local-6989586621679122395"><span class="hs-identifier hs-var">traces</span></a></span><span>
</span><span id="line-314"></span><span>
</span><span id="line-315"></span><span class="hs-comment">{- |
  INTERNAL: Adds some traces to whatever the currently open (innermost)
  transaction or savepoint is for this stack.
-}</span><span>
</span><span id="line-319"></span><span id="local-6989586621679122595"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#appendTracesAtTopOfStack"><span class="hs-identifier hs-type">appendTracesAtTopOfStack</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-320"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">DList.DList</span></span><span> </span><span class="annot"><a href="#local-6989586621679122595"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-321"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TransactionStack"><span class="hs-identifier hs-type">TransactionStack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122595"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-322"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TransactionStack"><span class="hs-identifier hs-type">TransactionStack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122595"><span class="hs-identifier hs-type">trace</span></a></span></span><span>
</span><span id="line-323"></span><span id="appendTracesAtTopOfStack"><span class="annot"><span class="annottext">appendTracesAtTopOfStack :: DList trace -&gt; TransactionStack trace -&gt; TransactionStack trace
</span><a href="Orville.PostgreSQL.EntityTrace.html#appendTracesAtTopOfStack"><span class="hs-identifier hs-var hs-var">appendTracesAtTopOfStack</span></a></span></span><span> </span><span id="local-6989586621679122392"><span class="annot"><span class="annottext">DList trace
</span><a href="#local-6989586621679122392"><span class="hs-identifier hs-var">newTraces</span></a></span></span><span> </span><span id="local-6989586621679122391"><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122391"><span class="hs-identifier hs-var">stack</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-324"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122391"><span class="hs-identifier hs-var">stack</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-325"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TransactionOpened"><span class="hs-identifier hs-type">TransactionOpened</span></a></span><span> </span><span id="local-6989586621679122390"><span class="annot"><span class="annottext">DList trace
</span><a href="#local-6989586621679122390"><span class="hs-identifier hs-var">traces</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-326"></span><span>      </span><span class="annot"><span class="annottext">DList trace -&gt; TransactionStack trace
forall trace. DList trace -&gt; TransactionStack trace
</span><a href="Orville.PostgreSQL.EntityTrace.html#TransactionOpened"><span class="hs-identifier hs-var">TransactionOpened</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DList trace
</span><a href="#local-6989586621679122390"><span class="hs-identifier hs-var">traces</span></a></span><span> </span><span class="annot"><span class="annottext">DList trace -&gt; DList trace -&gt; DList trace
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">DList trace
</span><a href="#local-6989586621679122392"><span class="hs-identifier hs-var">newTraces</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#SavepointCreated"><span class="hs-identifier hs-type">SavepointCreated</span></a></span><span> </span><span id="local-6989586621679122389"><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122389"><span class="hs-identifier hs-var">savepoint</span></a></span></span><span> </span><span id="local-6989586621679122388"><span class="annot"><span class="annottext">DList trace
</span><a href="#local-6989586621679122388"><span class="hs-identifier hs-var">traces</span></a></span></span><span> </span><span id="local-6989586621679122387"><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122387"><span class="hs-identifier hs-var">remainingStack</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-328"></span><span>      </span><span class="annot"><span class="annottext">Savepoint
-&gt; DList trace -&gt; TransactionStack trace -&gt; TransactionStack trace
forall trace.
Savepoint
-&gt; DList trace -&gt; TransactionStack trace -&gt; TransactionStack trace
</span><a href="Orville.PostgreSQL.EntityTrace.html#SavepointCreated"><span class="hs-identifier hs-var">SavepointCreated</span></a></span><span> </span><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122389"><span class="hs-identifier hs-var">savepoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DList trace
</span><a href="#local-6989586621679122388"><span class="hs-identifier hs-var">traces</span></a></span><span> </span><span class="annot"><span class="annottext">DList trace -&gt; DList trace -&gt; DList trace
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">DList trace
</span><a href="#local-6989586621679122392"><span class="hs-identifier hs-var">newTraces</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122387"><span class="hs-identifier hs-var">remainingStack</span></a></span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span class="hs-comment">{- |
  INTERNAL: Releases a savepoint (and any savepoints that were created after
  it) from the stack, effectively &quot;committing&quot; it within the context of any
  outer transaction that may exist.

  If no matching savepoint can be found a 'Left' is produced with an error
  message.
-}</span><span>
</span><span id="line-338"></span><span id="local-6989586621679122566"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#releaseTransactionStackSavepoint"><span class="hs-identifier hs-type">releaseTransactionStackSavepoint</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-339"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#Savepoint"><span class="hs-identifier hs-type">O.Savepoint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-340"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TransactionStack"><span class="hs-identifier hs-type">TransactionStack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122566"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-341"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TransactionStack"><span class="hs-identifier hs-type">TransactionStack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122566"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-342"></span><span id="releaseTransactionStackSavepoint"><span class="annot"><span class="annottext">releaseTransactionStackSavepoint :: Savepoint
-&gt; TransactionStack trace -&gt; Either String (TransactionStack trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#releaseTransactionStackSavepoint"><span class="hs-identifier hs-var hs-var">releaseTransactionStackSavepoint</span></a></span></span><span> </span><span id="local-6989586621679122385"><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122385"><span class="hs-identifier hs-var">targetSavepoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-343"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679122594"><span class="annot"><a href="#local-6989586621679122384"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-344"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">DList.DList</span></span><span> </span><span class="annot"><a href="#local-6989586621679122594"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-345"></span><span>        </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TransactionStack"><span class="hs-identifier hs-type">TransactionStack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122594"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-346"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TransactionStack"><span class="hs-identifier hs-type">TransactionStack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122594"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-347"></span><span>      </span><span id="local-6989586621679122384"><span class="annot"><span class="annottext">go :: DList trace
-&gt; TransactionStack trace -&gt; Either String (TransactionStack trace)
</span><a href="#local-6989586621679122384"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679122383"><span class="annot"><span class="annottext">DList trace
</span><a href="#local-6989586621679122383"><span class="hs-identifier hs-var">savedTraces</span></a></span></span><span> </span><span id="local-6989586621679122382"><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122382"><span class="hs-identifier hs-var">stack</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-348"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122382"><span class="hs-identifier hs-var">stack</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-349"></span><span>          </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TransactionOpened"><span class="hs-identifier hs-type">TransactionOpened</span></a></span><span> </span><span class="annot"><span class="annottext">DList trace
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-350"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; Either String (TransactionStack trace)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Tried to release savepoint that could not be found in EntityTrace TransactionStack&quot;</span></span><span>
</span><span id="line-351"></span><span>          </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#SavepointCreated"><span class="hs-identifier hs-type">SavepointCreated</span></a></span><span> </span><span id="local-6989586621679122381"><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122381"><span class="hs-identifier hs-var">currentSavepoint</span></a></span></span><span> </span><span id="local-6989586621679122380"><span class="annot"><span class="annottext">DList trace
</span><a href="#local-6989586621679122380"><span class="hs-identifier hs-var">traces</span></a></span></span><span> </span><span id="local-6989586621679122379"><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122379"><span class="hs-identifier hs-var">remainingStack</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-352"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122381"><span class="hs-identifier hs-var">currentSavepoint</span></a></span><span> </span><span class="annot"><span class="annottext">Savepoint -&gt; Savepoint -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122385"><span class="hs-identifier hs-var">targetSavepoint</span></a></span><span>
</span><span id="line-353"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TransactionStack trace -&gt; Either String (TransactionStack trace)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DList trace -&gt; TransactionStack trace -&gt; TransactionStack trace
forall trace.
DList trace -&gt; TransactionStack trace -&gt; TransactionStack trace
</span><a href="Orville.PostgreSQL.EntityTrace.html#appendTracesAtTopOfStack"><span class="hs-identifier hs-var">appendTracesAtTopOfStack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DList trace
</span><a href="#local-6989586621679122380"><span class="hs-identifier hs-var">traces</span></a></span><span> </span><span class="annot"><span class="annottext">DList trace -&gt; DList trace -&gt; DList trace
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">DList trace
</span><a href="#local-6989586621679122383"><span class="hs-identifier hs-var">savedTraces</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122379"><span class="hs-identifier hs-var">remainingStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-354"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">DList trace
-&gt; TransactionStack trace -&gt; Either String (TransactionStack trace)
forall trace.
DList trace
-&gt; TransactionStack trace -&gt; Either String (TransactionStack trace)
</span><a href="#local-6989586621679122384"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DList trace
</span><a href="#local-6989586621679122380"><span class="hs-identifier hs-var">traces</span></a></span><span> </span><span class="annot"><span class="annottext">DList trace -&gt; DList trace -&gt; DList trace
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">DList trace
</span><a href="#local-6989586621679122383"><span class="hs-identifier hs-var">savedTraces</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122379"><span class="hs-identifier hs-var">remainingStack</span></a></span><span>
</span><span id="line-355"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">DList trace
-&gt; TransactionStack trace -&gt; Either String (TransactionStack trace)
forall trace.
DList trace
-&gt; TransactionStack trace -&gt; Either String (TransactionStack trace)
</span><a href="#local-6989586621679122384"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">DList trace
forall a. DList a
</span><span class="hs-identifier hs-var">DList.empty</span></span><span>
</span><span id="line-356"></span><span>
</span><span id="line-357"></span><span class="hs-comment">{- |
  INTERNAL: Rolls back the transaction stack to a savepoint, eliminating any
  traces or savepoints that have happened since the savepoint was begun. Note
  that this does _not_ eliminate the targe savepoint, but does abandon any
  traces that are stored at its level of the stack, resetting to a state as if
  the savepoint had just been created.

  If no matching savepoint can be found a 'Left' is produced with an error message.
-}</span><span>
</span><span id="line-366"></span><span id="local-6989586621679122378"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#rollbackTransactionStackToSavepoint"><span class="hs-identifier hs-type">rollbackTransactionStackToSavepoint</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-367"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#Savepoint"><span class="hs-identifier hs-type">O.Savepoint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-368"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TransactionStack"><span class="hs-identifier hs-type">TransactionStack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122378"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-369"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TransactionStack"><span class="hs-identifier hs-type">TransactionStack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122378"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-370"></span><span id="rollbackTransactionStackToSavepoint"><span class="annot"><span class="annottext">rollbackTransactionStackToSavepoint :: Savepoint
-&gt; TransactionStack trace -&gt; Either String (TransactionStack trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#rollbackTransactionStackToSavepoint"><span class="hs-identifier hs-var hs-var">rollbackTransactionStackToSavepoint</span></a></span></span><span> </span><span id="local-6989586621679122376"><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122376"><span class="hs-identifier hs-var">targetSavepoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-371"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679122591"><span class="annot"><a href="#local-6989586621679122375"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TransactionStack"><span class="hs-identifier hs-type">TransactionStack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122591"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TransactionStack"><span class="hs-identifier hs-type">TransactionStack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122591"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-372"></span><span>      </span><span id="local-6989586621679122375"><span class="annot"><span class="annottext">go :: TransactionStack trace -&gt; Either String (TransactionStack trace)
</span><a href="#local-6989586621679122375"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679122374"><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122374"><span class="hs-identifier hs-var">stack</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-373"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122374"><span class="hs-identifier hs-var">stack</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-374"></span><span>          </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#TransactionOpened"><span class="hs-identifier hs-type">TransactionOpened</span></a></span><span> </span><span class="annot"><span class="annottext">DList trace
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-375"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; Either String (TransactionStack trace)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Tried to rollback savepoint that could not be found in EntityTrace TransactionStack&quot;</span></span><span>
</span><span id="line-376"></span><span>          </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#SavepointCreated"><span class="hs-identifier hs-type">SavepointCreated</span></a></span><span> </span><span id="local-6989586621679122373"><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122373"><span class="hs-identifier hs-var">currentSavepoint</span></a></span></span><span> </span><span id="local-6989586621679122372"><span class="annot"><span class="annottext">DList trace
</span><a href="#local-6989586621679122372"><span class="hs-identifier hs-var">_uncommitedTraces</span></a></span></span><span> </span><span id="local-6989586621679122371"><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122371"><span class="hs-identifier hs-var">remainingStack</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-377"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122373"><span class="hs-identifier hs-var">currentSavepoint</span></a></span><span> </span><span class="annot"><span class="annottext">Savepoint -&gt; Savepoint -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122376"><span class="hs-identifier hs-var">targetSavepoint</span></a></span><span>
</span><span id="line-378"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TransactionStack trace -&gt; Either String (TransactionStack trace)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Savepoint
-&gt; DList trace -&gt; TransactionStack trace -&gt; TransactionStack trace
forall trace.
Savepoint
-&gt; DList trace -&gt; TransactionStack trace -&gt; TransactionStack trace
</span><a href="Orville.PostgreSQL.EntityTrace.html#SavepointCreated"><span class="hs-identifier hs-var">SavepointCreated</span></a></span><span> </span><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122373"><span class="hs-identifier hs-var">currentSavepoint</span></a></span><span> </span><span class="annot"><span class="annottext">DList trace
forall a. DList a
</span><span class="hs-identifier hs-var">DList.empty</span></span><span> </span><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122371"><span class="hs-identifier hs-var">remainingStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-379"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">TransactionStack trace -&gt; Either String (TransactionStack trace)
forall trace.
TransactionStack trace -&gt; Either String (TransactionStack trace)
</span><a href="#local-6989586621679122375"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122371"><span class="hs-identifier hs-var">remainingStack</span></a></span><span>
</span><span id="line-380"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">TransactionStack trace -&gt; Either String (TransactionStack trace)
forall trace.
TransactionStack trace -&gt; Either String (TransactionStack trace)
</span><a href="#local-6989586621679122375"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span class="hs-comment">{- |
  INTERNAL: A starting point for 'RecordedTraces' where nothing has been
  recorded and no transaction stack has been created. This state corresponds to
  when no transaction has yet been opened by the actions invoked by
  'runEntityTraceT'. This is not exposed so that 'runEntityTraceT' can ensure
  that the 'RecordedTraces' and the 'O.OrvilleState' are in sync at the
  beginning of the traced action.
-}</span><span>
</span><span id="line-390"></span><span id="local-6989586621679122528"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#emptyTraceData"><span class="hs-identifier hs-type">emptyTraceData</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#RecordedTraces"><span class="hs-identifier hs-type">RecordedTraces</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122528"><span class="hs-identifier hs-type">trace</span></a></span></span><span>
</span><span id="line-391"></span><span id="emptyTraceData"><span class="annot"><span class="annottext">emptyTraceData :: RecordedTraces trace
</span><a href="Orville.PostgreSQL.EntityTrace.html#emptyTraceData"><span class="hs-identifier hs-var hs-var">emptyTraceData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DList trace
-&gt; Maybe (TransactionStack trace) -&gt; RecordedTraces trace
forall trace.
DList trace
-&gt; Maybe (TransactionStack trace) -&gt; RecordedTraces trace
</span><a href="Orville.PostgreSQL.EntityTrace.html#RecordedTraces"><span class="hs-identifier hs-var">RecordedTraces</span></a></span><span> </span><span class="annot"><span class="annottext">DList trace
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Maybe (TransactionStack trace)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-392"></span><span>
</span><span id="line-393"></span><span class="hs-comment">{- |
  INTERNAL: A voided version of 'atomicModifyIORef'' since it is not offered
  as part of 'IORef'
-}</span><span>
</span><span id="line-397"></span><span id="local-6989586621679122582"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#atomicModifyIORef%27_"><span class="hs-identifier hs-type">atomicModifyIORef'_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="annot"><a href="#local-6989586621679122582"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679122582"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679122582"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-398"></span><span id="atomicModifyIORef%27_"><span class="annot"><span class="annottext">atomicModifyIORef'_ :: IORef a -&gt; (a -&gt; a) -&gt; IO ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#atomicModifyIORef%27_"><span class="hs-identifier hs-var hs-var">atomicModifyIORef'_</span></a></span></span><span> </span><span id="local-6989586621679122368"><span class="annot"><span class="annottext">IORef a
</span><a href="#local-6989586621679122368"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span id="local-6989586621679122367"><span class="annot"><span class="annottext">a -&gt; a
</span><a href="#local-6989586621679122367"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef a -&gt; (a -&gt; (a, ())) -&gt; IO ()
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="annot"><span class="annottext">IORef a
</span><a href="#local-6989586621679122368"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679122366"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679122366"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; a
</span><a href="#local-6989586621679122367"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679122366"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span class="hs-comment">{- |
  INTERNAL: Mutates the 'EntityTraceState' 'IORef' to add some traces to it.
-}</span><span>
</span><span id="line-403"></span><span id="local-6989586621679122542"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#addTracesToRecord"><span class="hs-identifier hs-type">addTracesToRecord</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceState"><span class="hs-identifier hs-type">EntityTraceState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122542"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679122542"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-404"></span><span id="addTracesToRecord"><span class="annot"><span class="annottext">addTracesToRecord :: EntityTraceState trace -&gt; [trace] -&gt; IO ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#addTracesToRecord"><span class="hs-identifier hs-var hs-var">addTracesToRecord</span></a></span></span><span> </span><span id="local-6989586621679122364"><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122364"><span class="hs-identifier hs-var">traceState</span></a></span></span><span> </span><span id="local-6989586621679122363"><span class="annot"><span class="annottext">[trace]
</span><a href="#local-6989586621679122363"><span class="hs-identifier hs-var">traces</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-405"></span><span>  </span><span class="annot"><span class="annottext">IORef (RecordedTraces trace)
-&gt; (RecordedTraces trace -&gt; RecordedTraces trace) -&gt; IO ()
forall a. IORef a -&gt; (a -&gt; a) -&gt; IO ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#atomicModifyIORef%27_"><span class="hs-identifier hs-var">atomicModifyIORef'_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityTraceState trace -&gt; IORef (RecordedTraces trace)
forall trace.
EntityTraceState trace -&gt; IORef (RecordedTraces trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#_entityTraceStateRef"><span class="hs-identifier hs-var hs-var">_entityTraceStateRef</span></a></span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122364"><span class="hs-identifier hs-var">traceState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((RecordedTraces trace -&gt; RecordedTraces trace) -&gt; IO ())
-&gt; (RecordedTraces trace -&gt; RecordedTraces trace) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679122362"><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122362"><span class="hs-identifier hs-var">recorded</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-406"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace -&gt; Maybe (TransactionStack trace)
forall trace.
RecordedTraces trace -&gt; Maybe (TransactionStack trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#currentTransactionStack"><span class="hs-identifier hs-var hs-var">currentTransactionStack</span></a></span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122362"><span class="hs-identifier hs-var">recorded</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-407"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679122361"><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122361"><span class="hs-identifier hs-var">uncommitted</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-408"></span><span>        </span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122362"><span class="hs-identifier hs-var">recorded</span></a></span><span>
</span><span id="line-409"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">currentTransactionStack :: Maybe (TransactionStack trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#currentTransactionStack"><span class="hs-identifier hs-var">currentTransactionStack</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-410"></span><span>              </span><span class="annot"><span class="annottext">TransactionStack trace -&gt; Maybe (TransactionStack trace)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(TransactionStack trace -&gt; Maybe (TransactionStack trace))
-&gt; TransactionStack trace -&gt; Maybe (TransactionStack trace)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DList trace -&gt; TransactionStack trace -&gt; TransactionStack trace
forall trace.
DList trace -&gt; TransactionStack trace -&gt; TransactionStack trace
</span><a href="Orville.PostgreSQL.EntityTrace.html#appendTracesAtTopOfStack"><span class="hs-identifier hs-var">appendTracesAtTopOfStack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[trace] -&gt; DList trace
forall a. [a] -&gt; DList a
</span><span class="hs-identifier hs-var">DList.fromList</span></span><span> </span><span class="annot"><span class="annottext">[trace]
</span><a href="#local-6989586621679122363"><span class="hs-identifier hs-var">traces</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122361"><span class="hs-identifier hs-var">uncommitted</span></a></span><span>
</span><span id="line-411"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-412"></span><span>      </span><span class="annot"><span class="annottext">Maybe (TransactionStack trace)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-413"></span><span>        </span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122362"><span class="hs-identifier hs-var">recorded</span></a></span><span>
</span><span id="line-414"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">committedTracesDList :: DList trace
</span><a href="Orville.PostgreSQL.EntityTrace.html#committedTracesDList"><span class="hs-identifier hs-var">committedTracesDList</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-415"></span><span>              </span><span class="annot"><span class="annottext">RecordedTraces trace -&gt; DList trace
forall trace. RecordedTraces trace -&gt; DList trace
</span><a href="Orville.PostgreSQL.EntityTrace.html#committedTracesDList"><span class="hs-identifier hs-var hs-var">committedTracesDList</span></a></span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122362"><span class="hs-identifier hs-var">recorded</span></a></span><span> </span><span class="annot"><span class="annottext">DList trace -&gt; DList trace -&gt; DList trace
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[trace] -&gt; DList trace
forall a. [a] -&gt; DList a
</span><span class="hs-identifier hs-var">DList.fromList</span></span><span> </span><span class="annot"><span class="annottext">[trace]
</span><a href="#local-6989586621679122363"><span class="hs-identifier hs-var">traces</span></a></span><span>
</span><span id="line-416"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-417"></span><span>
</span><span id="line-418"></span><span class="hs-comment">{- |
  INTERNAL: Responds to an Orville 'O.BeginTransaction' callback by mutating
  the 'EntityTraceState' to begin a new transaction stack. The 'EntityTraceState'
  is always expected to be in sync with the transaction state kept by orville,
  so if there is already a transaction stack open this raises an error.
-}</span><span>
</span><span id="line-424"></span><span id="local-6989586621679122519"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#beginTransaction"><span class="hs-identifier hs-type">beginTransaction</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceState"><span class="hs-identifier hs-type">EntityTraceState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122519"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-425"></span><span id="beginTransaction"><span class="annot"><span class="annottext">beginTransaction :: EntityTraceState trace -&gt; IO ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#beginTransaction"><span class="hs-identifier hs-var hs-var">beginTransaction</span></a></span></span><span> </span><span id="local-6989586621679122358"><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122358"><span class="hs-identifier hs-var">traceState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-426"></span><span>  </span><span id="local-6989586621679122357"><span class="annot"><span class="annottext">Maybe EntityTraceTransactionStateError
</span><a href="#local-6989586621679122357"><span class="hs-identifier hs-var">mbError</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-427"></span><span>    </span><span class="annot"><span class="annottext">IORef (RecordedTraces trace)
-&gt; (RecordedTraces trace
    -&gt; (RecordedTraces trace, Maybe EntityTraceTransactionStateError))
-&gt; IO (Maybe EntityTraceTransactionStateError)
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityTraceState trace -&gt; IORef (RecordedTraces trace)
forall trace.
EntityTraceState trace -&gt; IORef (RecordedTraces trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#_entityTraceStateRef"><span class="hs-identifier hs-var hs-var">_entityTraceStateRef</span></a></span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122358"><span class="hs-identifier hs-var">traceState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((RecordedTraces trace
  -&gt; (RecordedTraces trace, Maybe EntityTraceTransactionStateError))
 -&gt; IO (Maybe EntityTraceTransactionStateError))
-&gt; (RecordedTraces trace
    -&gt; (RecordedTraces trace, Maybe EntityTraceTransactionStateError))
-&gt; IO (Maybe EntityTraceTransactionStateError)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679122356"><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122356"><span class="hs-identifier hs-var">recorded</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-428"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace -&gt; Maybe (TransactionStack trace)
forall trace.
RecordedTraces trace -&gt; Maybe (TransactionStack trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#currentTransactionStack"><span class="hs-identifier hs-var hs-var">currentTransactionStack</span></a></span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122356"><span class="hs-identifier hs-var">recorded</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-429"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">TransactionStack trace
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-430"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122356"><span class="hs-identifier hs-var">recorded</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError
-&gt; Maybe EntityTraceTransactionStateError
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#beginTransactionStateError"><span class="hs-identifier hs-var">beginTransactionStateError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span>        </span><span class="annot"><span class="annottext">Maybe (TransactionStack trace)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-432"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122356"><span class="hs-identifier hs-var">recorded</span></a></span><span>
</span><span id="line-433"></span><span>              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">currentTransactionStack :: Maybe (TransactionStack trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#currentTransactionStack"><span class="hs-identifier hs-var">currentTransactionStack</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionStack trace -&gt; Maybe (TransactionStack trace)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DList trace -&gt; TransactionStack trace
forall trace. DList trace -&gt; TransactionStack trace
</span><a href="Orville.PostgreSQL.EntityTrace.html#TransactionOpened"><span class="hs-identifier hs-var">TransactionOpened</span></a></span><span> </span><span class="annot"><span class="annottext">DList trace
forall a. DList a
</span><span class="hs-identifier hs-var">DList.empty</span></span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-435"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe EntityTraceTransactionStateError
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-436"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-437"></span><span>
</span><span id="line-438"></span><span>  </span><span class="annot"><span class="annottext">(EntityTraceTransactionStateError -&gt; IO Any)
-&gt; Maybe EntityTraceTransactionStateError -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError -&gt; IO Any
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">Ex.throwIO</span></span><span> </span><span class="annot"><span class="annottext">Maybe EntityTraceTransactionStateError
</span><a href="#local-6989586621679122357"><span class="hs-identifier hs-var">mbError</span></a></span><span>
</span><span id="line-439"></span><span>
</span><span id="line-440"></span><span class="hs-comment">{- |
  INTERNAL: Responds to an Orville 'O.CommitTransaction' callback by mutating
  the 'EntityTraceState' to commit the current transaction stack. The 'EntityTraceState'
  is always expected to be in sync with the transaction state kept by orville,
  so if there is no transaction stack this raises an error.
-}</span><span>
</span><span id="line-446"></span><span id="local-6989586621679122353"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#commitTransaction"><span class="hs-identifier hs-type">commitTransaction</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceState"><span class="hs-identifier hs-type">EntityTraceState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122353"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-447"></span><span id="commitTransaction"><span class="annot"><span class="annottext">commitTransaction :: EntityTraceState trace -&gt; IO ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#commitTransaction"><span class="hs-identifier hs-var hs-var">commitTransaction</span></a></span></span><span> </span><span id="local-6989586621679122351"><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122351"><span class="hs-identifier hs-var">traceState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-448"></span><span>  </span><span id="local-6989586621679122350"><span class="annot"><span class="annottext">Maybe EntityTraceTransactionStateError
</span><a href="#local-6989586621679122350"><span class="hs-identifier hs-var">mbError</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-449"></span><span>    </span><span class="annot"><span class="annottext">IORef (RecordedTraces trace)
-&gt; (RecordedTraces trace
    -&gt; (RecordedTraces trace, Maybe EntityTraceTransactionStateError))
-&gt; IO (Maybe EntityTraceTransactionStateError)
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityTraceState trace -&gt; IORef (RecordedTraces trace)
forall trace.
EntityTraceState trace -&gt; IORef (RecordedTraces trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#_entityTraceStateRef"><span class="hs-identifier hs-var hs-var">_entityTraceStateRef</span></a></span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122351"><span class="hs-identifier hs-var">traceState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((RecordedTraces trace
  -&gt; (RecordedTraces trace, Maybe EntityTraceTransactionStateError))
 -&gt; IO (Maybe EntityTraceTransactionStateError))
-&gt; (RecordedTraces trace
    -&gt; (RecordedTraces trace, Maybe EntityTraceTransactionStateError))
-&gt; IO (Maybe EntityTraceTransactionStateError)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679122349"><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122349"><span class="hs-identifier hs-var">recorded</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-450"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace -&gt; Maybe (TransactionStack trace)
forall trace.
RecordedTraces trace -&gt; Maybe (TransactionStack trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#currentTransactionStack"><span class="hs-identifier hs-var hs-var">currentTransactionStack</span></a></span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122349"><span class="hs-identifier hs-var">recorded</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-451"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679122348"><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122348"><span class="hs-identifier hs-var">stack</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-452"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122349"><span class="hs-identifier hs-var">recorded</span></a></span><span>
</span><span id="line-453"></span><span>              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">currentTransactionStack :: Maybe (TransactionStack trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#currentTransactionStack"><span class="hs-identifier hs-var">currentTransactionStack</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (TransactionStack trace)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-454"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">committedTracesDList :: DList trace
</span><a href="Orville.PostgreSQL.EntityTrace.html#committedTracesDList"><span class="hs-identifier hs-var">committedTracesDList</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace -&gt; DList trace
forall trace. RecordedTraces trace -&gt; DList trace
</span><a href="Orville.PostgreSQL.EntityTrace.html#committedTracesDList"><span class="hs-identifier hs-var hs-var">committedTracesDList</span></a></span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122349"><span class="hs-identifier hs-var">recorded</span></a></span><span> </span><span class="annot"><span class="annottext">DList trace -&gt; DList trace -&gt; DList trace
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TransactionStack trace -&gt; DList trace
forall trace. TransactionStack trace -&gt; DList trace
</span><a href="Orville.PostgreSQL.EntityTrace.html#allTransactionStackTraces"><span class="hs-identifier hs-var">allTransactionStackTraces</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122348"><span class="hs-identifier hs-var">stack</span></a></span><span>
</span><span id="line-455"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-456"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe EntityTraceTransactionStateError
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-457"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-458"></span><span>        </span><span class="annot"><span class="annottext">Maybe (TransactionStack trace)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-459"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122349"><span class="hs-identifier hs-var">recorded</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError
-&gt; Maybe EntityTraceTransactionStateError
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#commitTransactionStateError"><span class="hs-identifier hs-var">commitTransactionStateError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-460"></span><span>
</span><span id="line-461"></span><span>  </span><span class="annot"><span class="annottext">(EntityTraceTransactionStateError -&gt; IO Any)
-&gt; Maybe EntityTraceTransactionStateError -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError -&gt; IO Any
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">Ex.throwIO</span></span><span> </span><span class="annot"><span class="annottext">Maybe EntityTraceTransactionStateError
</span><a href="#local-6989586621679122350"><span class="hs-identifier hs-var">mbError</span></a></span><span>
</span><span id="line-462"></span><span>
</span><span id="line-463"></span><span class="hs-comment">{- |
  INTERNAL: Responds to an Orville 'O.RollbackTransaction' callback by mutating
  the 'EntityTraceState' to abandon the current transaction stack. The
  'EntityTraceState' is always expected to be in sync with the transaction
  state kept by orville, so if there is no transaction stack this raises an
  error.
-}</span><span>
</span><span id="line-470"></span><span id="local-6989586621679122346"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#rollbackTransaction"><span class="hs-identifier hs-type">rollbackTransaction</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceState"><span class="hs-identifier hs-type">EntityTraceState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122346"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-471"></span><span id="rollbackTransaction"><span class="annot"><span class="annottext">rollbackTransaction :: EntityTraceState trace -&gt; IO ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#rollbackTransaction"><span class="hs-identifier hs-var hs-var">rollbackTransaction</span></a></span></span><span> </span><span id="local-6989586621679122344"><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122344"><span class="hs-identifier hs-var">traceState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-472"></span><span>  </span><span id="local-6989586621679122343"><span class="annot"><span class="annottext">Maybe EntityTraceTransactionStateError
</span><a href="#local-6989586621679122343"><span class="hs-identifier hs-var">mbError</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-473"></span><span>    </span><span class="annot"><span class="annottext">IORef (RecordedTraces trace)
-&gt; (RecordedTraces trace
    -&gt; (RecordedTraces trace, Maybe EntityTraceTransactionStateError))
-&gt; IO (Maybe EntityTraceTransactionStateError)
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityTraceState trace -&gt; IORef (RecordedTraces trace)
forall trace.
EntityTraceState trace -&gt; IORef (RecordedTraces trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#_entityTraceStateRef"><span class="hs-identifier hs-var hs-var">_entityTraceStateRef</span></a></span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122344"><span class="hs-identifier hs-var">traceState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((RecordedTraces trace
  -&gt; (RecordedTraces trace, Maybe EntityTraceTransactionStateError))
 -&gt; IO (Maybe EntityTraceTransactionStateError))
-&gt; (RecordedTraces trace
    -&gt; (RecordedTraces trace, Maybe EntityTraceTransactionStateError))
-&gt; IO (Maybe EntityTraceTransactionStateError)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679122342"><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122342"><span class="hs-identifier hs-var">recorded</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-474"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace -&gt; Maybe (TransactionStack trace)
forall trace.
RecordedTraces trace -&gt; Maybe (TransactionStack trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#currentTransactionStack"><span class="hs-identifier hs-var hs-var">currentTransactionStack</span></a></span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122342"><span class="hs-identifier hs-var">recorded</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-475"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">TransactionStack trace
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-476"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122342"><span class="hs-identifier hs-var">recorded</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">currentTransactionStack :: Maybe (TransactionStack trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#currentTransactionStack"><span class="hs-identifier hs-var">currentTransactionStack</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (TransactionStack trace)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe EntityTraceTransactionStateError
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-477"></span><span>        </span><span class="annot"><span class="annottext">Maybe (TransactionStack trace)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-478"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122342"><span class="hs-identifier hs-var">recorded</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError
-&gt; Maybe EntityTraceTransactionStateError
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#rollbackTransactionStateError"><span class="hs-identifier hs-var">rollbackTransactionStateError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-479"></span><span>
</span><span id="line-480"></span><span>  </span><span class="annot"><span class="annottext">(EntityTraceTransactionStateError -&gt; IO Any)
-&gt; Maybe EntityTraceTransactionStateError -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError -&gt; IO Any
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">Ex.throwIO</span></span><span> </span><span class="annot"><span class="annottext">Maybe EntityTraceTransactionStateError
</span><a href="#local-6989586621679122343"><span class="hs-identifier hs-var">mbError</span></a></span><span>
</span><span id="line-481"></span><span>
</span><span id="line-482"></span><span class="hs-comment">{- |
  INTERNAL: Responds to an Orville 'O.NewSavepoint' callback by mutating the
  'EntityTraceState' to add a new savpoint to the top with the given
  identifier. The 'EntityTraceState' is always expected to be in sync with the
  transaction state kept by orville, so if there is no transaction stack this
  raises an error.
-}</span><span>
</span><span id="line-489"></span><span id="local-6989586621679122518"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#newSavepoint"><span class="hs-identifier hs-type">newSavepoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#Savepoint"><span class="hs-identifier hs-type">O.Savepoint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceState"><span class="hs-identifier hs-type">EntityTraceState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122518"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-490"></span><span id="newSavepoint"><span class="annot"><span class="annottext">newSavepoint :: Savepoint -&gt; EntityTraceState trace -&gt; IO ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#newSavepoint"><span class="hs-identifier hs-var hs-var">newSavepoint</span></a></span></span><span> </span><span id="local-6989586621679122339"><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122339"><span class="hs-identifier hs-var">savepoint</span></a></span></span><span> </span><span id="local-6989586621679122338"><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122338"><span class="hs-identifier hs-var">traceState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-491"></span><span>  </span><span id="local-6989586621679122337"><span class="annot"><span class="annottext">Maybe EntityTraceTransactionStateError
</span><a href="#local-6989586621679122337"><span class="hs-identifier hs-var">mbError</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-492"></span><span>    </span><span class="annot"><span class="annottext">IORef (RecordedTraces trace)
-&gt; (RecordedTraces trace
    -&gt; (RecordedTraces trace, Maybe EntityTraceTransactionStateError))
-&gt; IO (Maybe EntityTraceTransactionStateError)
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityTraceState trace -&gt; IORef (RecordedTraces trace)
forall trace.
EntityTraceState trace -&gt; IORef (RecordedTraces trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#_entityTraceStateRef"><span class="hs-identifier hs-var hs-var">_entityTraceStateRef</span></a></span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122338"><span class="hs-identifier hs-var">traceState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((RecordedTraces trace
  -&gt; (RecordedTraces trace, Maybe EntityTraceTransactionStateError))
 -&gt; IO (Maybe EntityTraceTransactionStateError))
-&gt; (RecordedTraces trace
    -&gt; (RecordedTraces trace, Maybe EntityTraceTransactionStateError))
-&gt; IO (Maybe EntityTraceTransactionStateError)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679122336"><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122336"><span class="hs-identifier hs-var">recorded</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-493"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace -&gt; Maybe (TransactionStack trace)
forall trace.
RecordedTraces trace -&gt; Maybe (TransactionStack trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#currentTransactionStack"><span class="hs-identifier hs-var hs-var">currentTransactionStack</span></a></span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122336"><span class="hs-identifier hs-var">recorded</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-494"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679122335"><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122335"><span class="hs-identifier hs-var">stack</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-495"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122336"><span class="hs-identifier hs-var">recorded</span></a></span><span>
</span><span id="line-496"></span><span>              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">currentTransactionStack :: Maybe (TransactionStack trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#currentTransactionStack"><span class="hs-identifier hs-var">currentTransactionStack</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionStack trace -&gt; Maybe (TransactionStack trace)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Savepoint
-&gt; DList trace -&gt; TransactionStack trace -&gt; TransactionStack trace
forall trace.
Savepoint
-&gt; DList trace -&gt; TransactionStack trace -&gt; TransactionStack trace
</span><a href="Orville.PostgreSQL.EntityTrace.html#SavepointCreated"><span class="hs-identifier hs-var">SavepointCreated</span></a></span><span> </span><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122339"><span class="hs-identifier hs-var">savepoint</span></a></span><span> </span><span class="annot"><span class="annottext">DList trace
forall a. DList a
</span><span class="hs-identifier hs-var">DList.empty</span></span><span> </span><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122335"><span class="hs-identifier hs-var">stack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-497"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-498"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe EntityTraceTransactionStateError
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-499"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-500"></span><span>        </span><span class="annot"><span class="annottext">Maybe (TransactionStack trace)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-501"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122336"><span class="hs-identifier hs-var">recorded</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError
-&gt; Maybe EntityTraceTransactionStateError
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#newSavepointTransactionStateError"><span class="hs-identifier hs-var">newSavepointTransactionStateError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-502"></span><span>
</span><span id="line-503"></span><span>  </span><span class="annot"><span class="annottext">(EntityTraceTransactionStateError -&gt; IO Any)
-&gt; Maybe EntityTraceTransactionStateError -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError -&gt; IO Any
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">Ex.throwIO</span></span><span> </span><span class="annot"><span class="annottext">Maybe EntityTraceTransactionStateError
</span><a href="#local-6989586621679122337"><span class="hs-identifier hs-var">mbError</span></a></span><span>
</span><span id="line-504"></span><span>
</span><span id="line-505"></span><span class="hs-comment">{- |
  INTERNAL: Responds to an Orville 'O.ReleaseSavepoint' callback by mutating
  the 'EntityTraceState' to released the savepoint with provided identifier.
  The 'EntityTraceState' is always expected to be in sync with the transaction
  state kept by orville, so if there is no transaction stack or no matching
  savepoint can be found this raises an error.
-}</span><span>
</span><span id="line-512"></span><span id="local-6989586621679122333"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#releaseSavepoint"><span class="hs-identifier hs-type">releaseSavepoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#Savepoint"><span class="hs-identifier hs-type">O.Savepoint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceState"><span class="hs-identifier hs-type">EntityTraceState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122333"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-513"></span><span id="releaseSavepoint"><span class="annot"><span class="annottext">releaseSavepoint :: Savepoint -&gt; EntityTraceState trace -&gt; IO ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#releaseSavepoint"><span class="hs-identifier hs-var hs-var">releaseSavepoint</span></a></span></span><span> </span><span id="local-6989586621679122331"><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122331"><span class="hs-identifier hs-var">savepoint</span></a></span></span><span> </span><span id="local-6989586621679122330"><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122330"><span class="hs-identifier hs-var">traceState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-514"></span><span>  </span><span id="local-6989586621679122329"><span class="annot"><span class="annottext">Maybe EntityTraceTransactionStateError
</span><a href="#local-6989586621679122329"><span class="hs-identifier hs-var">mbError</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-515"></span><span>    </span><span class="annot"><span class="annottext">IORef (RecordedTraces trace)
-&gt; (RecordedTraces trace
    -&gt; (RecordedTraces trace, Maybe EntityTraceTransactionStateError))
-&gt; IO (Maybe EntityTraceTransactionStateError)
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityTraceState trace -&gt; IORef (RecordedTraces trace)
forall trace.
EntityTraceState trace -&gt; IORef (RecordedTraces trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#_entityTraceStateRef"><span class="hs-identifier hs-var hs-var">_entityTraceStateRef</span></a></span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122330"><span class="hs-identifier hs-var">traceState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((RecordedTraces trace
  -&gt; (RecordedTraces trace, Maybe EntityTraceTransactionStateError))
 -&gt; IO (Maybe EntityTraceTransactionStateError))
-&gt; (RecordedTraces trace
    -&gt; (RecordedTraces trace, Maybe EntityTraceTransactionStateError))
-&gt; IO (Maybe EntityTraceTransactionStateError)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679122328"><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122328"><span class="hs-identifier hs-var">recorded</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-516"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace -&gt; Maybe (TransactionStack trace)
forall trace.
RecordedTraces trace -&gt; Maybe (TransactionStack trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#currentTransactionStack"><span class="hs-identifier hs-var hs-var">currentTransactionStack</span></a></span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122328"><span class="hs-identifier hs-var">recorded</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-517"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679122327"><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122327"><span class="hs-identifier hs-var">uncommitted</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-518"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Savepoint
-&gt; TransactionStack trace -&gt; Either String (TransactionStack trace)
forall trace.
Savepoint
-&gt; TransactionStack trace -&gt; Either String (TransactionStack trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#releaseTransactionStackSavepoint"><span class="hs-identifier hs-var">releaseTransactionStackSavepoint</span></a></span><span> </span><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122331"><span class="hs-identifier hs-var">savepoint</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122327"><span class="hs-identifier hs-var">uncommitted</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-519"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-520"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122328"><span class="hs-identifier hs-var">recorded</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError
-&gt; Maybe EntityTraceTransactionStateError
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#releaseSavepointNoMatchingSavepointError"><span class="hs-identifier hs-var">releaseSavepointNoMatchingSavepointError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-521"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679122325"><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122325"><span class="hs-identifier hs-var">newStack</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-522"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122328"><span class="hs-identifier hs-var">recorded</span></a></span><span>
</span><span id="line-523"></span><span>                  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">currentTransactionStack :: Maybe (TransactionStack trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#currentTransactionStack"><span class="hs-identifier hs-var">currentTransactionStack</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionStack trace -&gt; Maybe (TransactionStack trace)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122325"><span class="hs-identifier hs-var">newStack</span></a></span><span>
</span><span id="line-524"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-525"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe EntityTraceTransactionStateError
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-526"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-527"></span><span>        </span><span class="annot"><span class="annottext">Maybe (TransactionStack trace)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-528"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122328"><span class="hs-identifier hs-var">recorded</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError
-&gt; Maybe EntityTraceTransactionStateError
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#releaseSavepointNoTransactionError"><span class="hs-identifier hs-var">releaseSavepointNoTransactionError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-529"></span><span>
</span><span id="line-530"></span><span>  </span><span class="annot"><span class="annottext">(EntityTraceTransactionStateError -&gt; IO Any)
-&gt; Maybe EntityTraceTransactionStateError -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError -&gt; IO Any
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">Ex.throwIO</span></span><span> </span><span class="annot"><span class="annottext">Maybe EntityTraceTransactionStateError
</span><a href="#local-6989586621679122329"><span class="hs-identifier hs-var">mbError</span></a></span><span>
</span><span id="line-531"></span><span>
</span><span id="line-532"></span><span class="hs-comment">{- |
  INTERNAL: Responds to an Orville 'O.RollbackToSavepoint' callback by mutating
  the 'EntityTraceState' to roll back to the savepoint with provided
  identifier. The 'EntityTraceState' is always expected to be in sync with the
  transaction state kept by orville, so if there is no transaction stack or no
  matching savepoint can be found this raises an error.
-}</span><span>
</span><span id="line-539"></span><span id="local-6989586621679122323"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#rollbackToSavepoint"><span class="hs-identifier hs-type">rollbackToSavepoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#Savepoint"><span class="hs-identifier hs-type">O.Savepoint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceState"><span class="hs-identifier hs-type">EntityTraceState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122323"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-540"></span><span id="rollbackToSavepoint"><span class="annot"><span class="annottext">rollbackToSavepoint :: Savepoint -&gt; EntityTraceState trace -&gt; IO ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#rollbackToSavepoint"><span class="hs-identifier hs-var hs-var">rollbackToSavepoint</span></a></span></span><span> </span><span id="local-6989586621679122321"><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122321"><span class="hs-identifier hs-var">savepoint</span></a></span></span><span> </span><span id="local-6989586621679122320"><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122320"><span class="hs-identifier hs-var">traceState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-541"></span><span>  </span><span id="local-6989586621679122319"><span class="annot"><span class="annottext">Maybe EntityTraceTransactionStateError
</span><a href="#local-6989586621679122319"><span class="hs-identifier hs-var">mbError</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-542"></span><span>    </span><span class="annot"><span class="annottext">IORef (RecordedTraces trace)
-&gt; (RecordedTraces trace
    -&gt; (RecordedTraces trace, Maybe EntityTraceTransactionStateError))
-&gt; IO (Maybe EntityTraceTransactionStateError)
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityTraceState trace -&gt; IORef (RecordedTraces trace)
forall trace.
EntityTraceState trace -&gt; IORef (RecordedTraces trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#_entityTraceStateRef"><span class="hs-identifier hs-var hs-var">_entityTraceStateRef</span></a></span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122320"><span class="hs-identifier hs-var">traceState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((RecordedTraces trace
  -&gt; (RecordedTraces trace, Maybe EntityTraceTransactionStateError))
 -&gt; IO (Maybe EntityTraceTransactionStateError))
-&gt; (RecordedTraces trace
    -&gt; (RecordedTraces trace, Maybe EntityTraceTransactionStateError))
-&gt; IO (Maybe EntityTraceTransactionStateError)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679122318"><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122318"><span class="hs-identifier hs-var">recorded</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-543"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace -&gt; Maybe (TransactionStack trace)
forall trace.
RecordedTraces trace -&gt; Maybe (TransactionStack trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#currentTransactionStack"><span class="hs-identifier hs-var hs-var">currentTransactionStack</span></a></span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122318"><span class="hs-identifier hs-var">recorded</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-544"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679122317"><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122317"><span class="hs-identifier hs-var">uncommitted</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-545"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Savepoint
-&gt; TransactionStack trace -&gt; Either String (TransactionStack trace)
forall trace.
Savepoint
-&gt; TransactionStack trace -&gt; Either String (TransactionStack trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#rollbackTransactionStackToSavepoint"><span class="hs-identifier hs-var">rollbackTransactionStackToSavepoint</span></a></span><span> </span><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122321"><span class="hs-identifier hs-var">savepoint</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122317"><span class="hs-identifier hs-var">uncommitted</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-546"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-547"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122318"><span class="hs-identifier hs-var">recorded</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError
-&gt; Maybe EntityTraceTransactionStateError
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#rollbackToSavepointNoMatchingSavepointError"><span class="hs-identifier hs-var">rollbackToSavepointNoMatchingSavepointError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-548"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679122315"><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122315"><span class="hs-identifier hs-var">newStack</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-549"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122318"><span class="hs-identifier hs-var">recorded</span></a></span><span>
</span><span id="line-550"></span><span>                  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">currentTransactionStack :: Maybe (TransactionStack trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#currentTransactionStack"><span class="hs-identifier hs-var">currentTransactionStack</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionStack trace -&gt; Maybe (TransactionStack trace)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">TransactionStack trace
</span><a href="#local-6989586621679122315"><span class="hs-identifier hs-var">newStack</span></a></span><span>
</span><span id="line-551"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-552"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe EntityTraceTransactionStateError
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-553"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-554"></span><span>        </span><span class="annot"><span class="annottext">Maybe (TransactionStack trace)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-555"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122318"><span class="hs-identifier hs-var">recorded</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError
-&gt; Maybe EntityTraceTransactionStateError
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#rollbackToSavepointNoTransactionError"><span class="hs-identifier hs-var">rollbackToSavepointNoTransactionError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-556"></span><span>
</span><span id="line-557"></span><span>  </span><span class="annot"><span class="annottext">(EntityTraceTransactionStateError -&gt; IO Any)
-&gt; Maybe EntityTraceTransactionStateError -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError -&gt; IO Any
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">Ex.throwIO</span></span><span> </span><span class="annot"><span class="annottext">Maybe EntityTraceTransactionStateError
</span><a href="#local-6989586621679122319"><span class="hs-identifier hs-var">mbError</span></a></span><span>
</span><span id="line-558"></span><span>
</span><span id="line-559"></span><span class="hs-comment">{- |
  'EntityTraceT' is simply a synonym for 'ReaderT' over an 'EntityTraceState'.
  The 'EntityTraceState' keeps track of what traces have been recorded,
  including keeping them in sync with any transaction or savepoint operations
  that are performed via the 'O.withTransaction' function. I.E. if a
  transaction or savepoint is rolled-back any traces that had been recorded by
  'insertEntityTraced', 'updateEntityTrace', or 'deletedEntityTraced' are also
  rolled-back.
-}</span><span>
</span><span id="line-568"></span><span class="hs-keyword">type</span><span> </span><span id="EntityTraceT"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceT"><span class="hs-identifier hs-var">EntityTraceT</span></a></span></span><span> </span><span id="local-6989586621679122313"><span class="annot"><a href="#local-6989586621679122313"><span class="hs-identifier hs-type">trace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-569"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceState"><span class="hs-identifier hs-type">EntityTraceState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122313"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-570"></span><span>
</span><span id="line-571"></span><span id="local-6989586621679122311"><span id="local-6989586621679122312"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#MonadOrville"><span class="hs-identifier hs-type">O.MonadOrville</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122312"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#MonadEntityTrace"><span class="hs-identifier hs-type">MonadEntityTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122311"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceState"><span class="hs-identifier hs-type">EntityTraceState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122311"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679122312"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-572"></span><span>  </span><span id="local-6989586621679122306"><span class="annot"><span class="annottext">recordTraces :: [trace] -&gt; ReaderT (EntityTraceState trace) m ()
</span><a href="#local-6989586621679122306"><span class="hs-identifier hs-var hs-var hs-var hs-var">recordTraces</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-573"></span><span>    </span><span class="annot"><span class="annottext">ReaderT (EntityTraceState trace) m (EntityTraceState trace)
-&gt; [trace] -&gt; ReaderT (EntityTraceState trace) m ()
forall (m :: * -&gt; *) trace.
MonadIO m =&gt;
m (EntityTraceState trace) -&gt; [trace] -&gt; m ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#recordTracesInState"><span class="hs-identifier hs-var">recordTracesInState</span></a></span><span> </span><span class="annot"><span class="annottext">ReaderT (EntityTraceState trace) m (EntityTraceState trace)
forall (m :: * -&gt; *) r. Monad m =&gt; ReaderT r m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-574"></span><span>
</span><span id="line-575"></span><span>  </span><span id="local-6989586621679122304"><span class="annot"><span class="annottext">liftOrvilleUntraced :: (forall (n :: * -&gt; *). MonadOrville n =&gt; n a)
-&gt; ReaderT (EntityTraceState trace) m a
</span><a href="#local-6989586621679122304"><span class="hs-identifier hs-var hs-var hs-var hs-var">liftOrvilleUntraced</span></a></span></span><span> </span><span id="local-6989586621679122303"><span class="annot"><span class="annottext">forall (n :: * -&gt; *). MonadOrville n =&gt; n a
</span><a href="#local-6989586621679122303"><span class="hs-identifier hs-var">untraced</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-576"></span><span>    </span><span class="hs-comment">-- The 'untraced' argument must be explict here for GHC 9</span><span>
</span><span id="line-577"></span><span>    </span><span class="annot"><span class="annottext">m a -&gt; ReaderT (EntityTraceState trace) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">m a
forall (n :: * -&gt; *). MonadOrville n =&gt; n a
</span><a href="#local-6989586621679122303"><span class="hs-identifier hs-var">untraced</span></a></span></span></span><span>
</span><span id="line-578"></span><span>
</span><span id="line-579"></span><span id="local-6989586621679122301"><span id="local-6989586621679122302"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#MonadOrville"><span class="hs-identifier hs-type">O.MonadOrville</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122302"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#MonadOrville"><span class="hs-identifier hs-type">O.MonadOrville</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceState"><span class="hs-identifier hs-type">EntityTraceState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122301"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679122302"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-580"></span><span>
</span><span id="line-581"></span><span class="hs-comment">{- |
  INTERNAL: Mutates the 'EntityTraceState' that is returned by the given &quot;ask&quot;
  operation. We may decide to expose this in the future so that it's possible
  to build an instance of 'MonadEntityTrace' by tracking an 'EntityTraceState'
  in a user-provided 'ReaderT' (or other) context, but to do so we would need
  to provide a relatively safe API for instantiating the 'EntityTraceState' and
  'O.OrvilleState' together to ensure that the transaction callback is
  registered and the transaction state between the two is in sync.
-}</span><span>
</span><span id="line-590"></span><span id="local-6989586621679122559"><span id="local-6989586621679122561"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#recordTracesInState"><span class="hs-identifier hs-type">recordTracesInState</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-591"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679122561"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-592"></span><span>  </span><span class="annot"><a href="#local-6989586621679122561"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceState"><span class="hs-identifier hs-type">EntityTraceState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122559"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-593"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679122559"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-594"></span><span>  </span><span class="annot"><a href="#local-6989586621679122561"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-595"></span><span id="recordTracesInState"><span class="annot"><span class="annottext">recordTracesInState :: m (EntityTraceState trace) -&gt; [trace] -&gt; m ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#recordTracesInState"><span class="hs-identifier hs-var hs-var">recordTracesInState</span></a></span></span><span> </span><span id="local-6989586621679122296"><span class="annot"><span class="annottext">m (EntityTraceState trace)
</span><a href="#local-6989586621679122296"><span class="hs-identifier hs-var">askTraceState</span></a></span></span><span> </span><span id="local-6989586621679122295"><span class="annot"><span class="annottext">[trace]
</span><a href="#local-6989586621679122295"><span class="hs-identifier hs-var">traces</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-596"></span><span>  </span><span id="local-6989586621679122294"><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122294"><span class="hs-identifier hs-var">recordedTraces</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (EntityTraceState trace)
</span><a href="#local-6989586621679122296"><span class="hs-identifier hs-var">askTraceState</span></a></span><span>
</span><span id="line-597"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace -&gt; [trace] -&gt; IO ()
forall trace. EntityTraceState trace -&gt; [trace] -&gt; IO ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#addTracesToRecord"><span class="hs-identifier hs-var">addTracesToRecord</span></a></span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122294"><span class="hs-identifier hs-var">recordedTraces</span></a></span><span> </span><span class="annot"><span class="annottext">[trace]
</span><a href="#local-6989586621679122295"><span class="hs-identifier hs-var">traces</span></a></span><span>
</span><span id="line-598"></span><span>
</span><span id="line-599"></span><span class="hs-comment">{- |
  'runEntityTraceT' runs an Orville action that has tracing behavior and
  returns the traces that were committed. Note that there will never be any
  uncommitted traces at the end because any 'O.withTransaction' block must by
  contained within the action passed  to 'runEntityTraceT'. This function
  creates a new 'O.OrvilleState' and passes it to the run function that you
  provide in order to enforce this.

  Note that if an exception occurs in 'm' and is not caught within the action passed
  to 'runEntityTraceT', you will lose any traces that may have happened up to
  the point of the action, including those related to database operations that were
  successfully committed. If you wish to respond to those traces, you need to catch
  the exception inside the action given to 'runEntityTraceT' so that it can return
  the traces to you.
-}</span><span>
</span><span id="line-614"></span><span id="local-6989586621679122290"><span id="local-6989586621679122291"><span id="local-6989586621679122292"><span id="local-6989586621679122293"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#runEntityTraceT"><span class="hs-identifier hs-type">runEntityTraceT</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-615"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679122293"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-616"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Internal.ErrorDetailLevel.html#ErrorDetailLevel"><span class="hs-identifier hs-type">O.ErrorDetailLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-617"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Pool</span></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Connection.html#Connection"><span class="hs-identifier hs-type">Conn.Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-618"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#OrvilleState"><span class="hs-identifier hs-type">O.OrvilleState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679122292"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122291"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679122293"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122291"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-619"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceT"><span class="hs-identifier hs-type">EntityTraceT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122290"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122292"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122291"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-620"></span><span>  </span><span class="annot"><a href="#local-6989586621679122293"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679122291"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679122290"><span class="hs-identifier hs-type">trace</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-621"></span><span id="runEntityTraceT"><span class="annot"><span class="annottext">runEntityTraceT :: ErrorDetailLevel
-&gt; Pool Connection
-&gt; (OrvilleState -&gt; m a -&gt; n a)
-&gt; EntityTraceT trace m a
-&gt; n (a, [trace])
</span><a href="Orville.PostgreSQL.EntityTrace.html#runEntityTraceT"><span class="hs-identifier hs-var hs-var">runEntityTraceT</span></a></span></span><span> </span><span id="local-6989586621679122289"><span class="annot"><span class="annottext">ErrorDetailLevel
</span><a href="#local-6989586621679122289"><span class="hs-identifier hs-var">errorDetailLevel</span></a></span></span><span> </span><span id="local-6989586621679122288"><span class="annot"><span class="annottext">Pool Connection
</span><a href="#local-6989586621679122288"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span id="local-6989586621679122287"><span class="annot"><span class="annottext">OrvilleState -&gt; m a -&gt; n a
</span><a href="#local-6989586621679122287"><span class="hs-identifier hs-var">runM</span></a></span></span><span> </span><span id="local-6989586621679122286"><span class="annot"><span class="annottext">EntityTraceT trace m a
</span><a href="#local-6989586621679122286"><span class="hs-identifier hs-var">traceT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-622"></span><span>  </span><span id="local-6989586621679122285"><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122285"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (EntityTraceState trace) -&gt; n (EntityTraceState trace)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (EntityTraceState trace) -&gt; n (EntityTraceState trace))
-&gt; IO (EntityTraceState trace) -&gt; n (EntityTraceState trace)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef (RecordedTraces trace) -&gt; EntityTraceState trace
forall trace.
IORef (RecordedTraces trace) -&gt; EntityTraceState trace
</span><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceState"><span class="hs-identifier hs-var">EntityTraceState</span></a></span><span> </span><span class="annot"><span class="annottext">(IORef (RecordedTraces trace) -&gt; EntityTraceState trace)
-&gt; IO (IORef (RecordedTraces trace)) -&gt; IO (EntityTraceState trace)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace -&gt; IO (IORef (RecordedTraces trace))
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace
forall trace. RecordedTraces trace
</span><a href="Orville.PostgreSQL.EntityTrace.html#emptyTraceData"><span class="hs-identifier hs-var">emptyTraceData</span></a></span><span>
</span><span id="line-623"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679122283"><span class="annot"><span class="annottext">mAction :: m a
</span><a href="#local-6989586621679122283"><span class="hs-identifier hs-var hs-var">mAction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-624"></span><span>        </span><span class="annot"><span class="annottext">EntityTraceT trace m a -&gt; EntityTraceState trace -&gt; m a
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">EntityTraceT trace m a
</span><a href="#local-6989586621679122286"><span class="hs-identifier hs-var">traceT</span></a></span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122285"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-625"></span><span>
</span><span id="line-626"></span><span>      </span><span id="local-6989586621679122282"><span class="annot"><span class="annottext">orvilleState :: OrvilleState
</span><a href="#local-6989586621679122282"><span class="hs-identifier hs-var hs-var">orvilleState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-627"></span><span>        </span><span class="annot"><span class="annottext">(TransactionEvent -&gt; IO ()) -&gt; OrvilleState -&gt; OrvilleState
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#addTransactionCallback"><span class="hs-identifier hs-var">O.addTransactionCallback</span></a></span><span>
</span><span id="line-628"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntityTraceState trace -&gt; TransactionEvent -&gt; IO ()
forall trace. EntityTraceState trace -&gt; TransactionEvent -&gt; IO ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#trackTransactions"><span class="hs-identifier hs-var">trackTransactions</span></a></span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122285"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-629"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ErrorDetailLevel -&gt; Pool Connection -&gt; OrvilleState
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#newOrvilleState"><span class="hs-identifier hs-var">O.newOrvilleState</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorDetailLevel
</span><a href="#local-6989586621679122289"><span class="hs-identifier hs-var">errorDetailLevel</span></a></span><span> </span><span class="annot"><span class="annottext">Pool Connection
</span><a href="#local-6989586621679122288"><span class="hs-identifier hs-var">pool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-630"></span><span>
</span><span id="line-631"></span><span>  </span><span id="local-6989586621679122278"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679122278"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OrvilleState -&gt; m a -&gt; n a
</span><a href="#local-6989586621679122287"><span class="hs-identifier hs-var">runM</span></a></span><span> </span><span class="annot"><span class="annottext">OrvilleState
</span><a href="#local-6989586621679122282"><span class="hs-identifier hs-var">orvilleState</span></a></span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679122283"><span class="hs-identifier hs-var">mAction</span></a></span><span>
</span><span id="line-632"></span><span>  </span><span id="local-6989586621679122277"><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122277"><span class="hs-identifier hs-var">traceData</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (RecordedTraces trace) -&gt; n (RecordedTraces trace)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IORef (RecordedTraces trace) -&gt; IO (RecordedTraces trace)
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(IORef (RecordedTraces trace) -&gt; IO (RecordedTraces trace))
-&gt; IORef (RecordedTraces trace) -&gt; IO (RecordedTraces trace)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace -&gt; IORef (RecordedTraces trace)
forall trace.
EntityTraceState trace -&gt; IORef (RecordedTraces trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#_entityTraceStateRef"><span class="hs-identifier hs-var hs-var">_entityTraceStateRef</span></a></span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122285"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-633"></span><span>
</span><span id="line-634"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace -&gt; Maybe (TransactionStack trace)
forall trace.
RecordedTraces trace -&gt; Maybe (TransactionStack trace)
</span><a href="Orville.PostgreSQL.EntityTrace.html#currentTransactionStack"><span class="hs-identifier hs-var hs-var">currentTransactionStack</span></a></span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122277"><span class="hs-identifier hs-var">traceData</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-635"></span><span>    </span><span class="annot"><span class="annottext">Maybe (TransactionStack trace)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-636"></span><span>      </span><span class="annot"><span class="annottext">(a, [trace]) -&gt; n (a, [trace])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679122278"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DList trace -&gt; [trace]
forall a. DList a -&gt; [a]
</span><span class="hs-identifier hs-var">DList.toList</span></span><span> </span><span class="annot"><span class="annottext">(DList trace -&gt; [trace]) -&gt; DList trace -&gt; [trace]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace -&gt; DList trace
forall trace. RecordedTraces trace -&gt; DList trace
</span><a href="Orville.PostgreSQL.EntityTrace.html#committedTracesDList"><span class="hs-identifier hs-var hs-var">committedTracesDList</span></a></span><span> </span><span class="annot"><span class="annottext">RecordedTraces trace
</span><a href="#local-6989586621679122277"><span class="hs-identifier hs-var">traceData</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-637"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">TransactionStack trace
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-638"></span><span>      </span><span class="annot"><span class="annottext">IO (a, [trace]) -&gt; n (a, [trace])
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (a, [trace]) -&gt; n (a, [trace]))
-&gt; IO (a, [trace]) -&gt; n (a, [trace])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError -&gt; IO (a, [trace])
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">Ex.throwIO</span></span><span> </span><span class="annot"><span class="annottext">EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#transactionStillOpenAtEndError"><span class="hs-identifier hs-var">transactionStillOpenAtEndError</span></a></span><span>
</span><span id="line-639"></span><span>
</span><span id="line-640"></span><span class="hs-comment">{- |
  INTERNAL: This function is registered as the transaction callback on the
  'O.OrvilleState' to keep the given 'EntityTraceState' transaction stack
  in sync with operations performed by 'O.withTransaction'.
-}</span><span>
</span><span id="line-645"></span><span id="local-6989586621679122523"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#trackTransactions"><span class="hs-identifier hs-type">trackTransactions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceState"><span class="hs-identifier hs-type">EntityTraceState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679122523"><span class="hs-identifier hs-type">trace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#TransactionEvent"><span class="hs-identifier hs-type">O.TransactionEvent</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-646"></span><span id="trackTransactions"><span class="annot"><span class="annottext">trackTransactions :: EntityTraceState trace -&gt; TransactionEvent -&gt; IO ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#trackTransactions"><span class="hs-identifier hs-var hs-var">trackTransactions</span></a></span></span><span> </span><span id="local-6989586621679122274"><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122274"><span class="hs-identifier hs-var">recorded</span></a></span></span><span> </span><span id="local-6989586621679122273"><span class="annot"><span class="annottext">TransactionEvent
</span><a href="#local-6989586621679122273"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-647"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TransactionEvent
</span><a href="#local-6989586621679122273"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-648"></span><span>    </span><span class="annot"><span class="annottext">TransactionEvent
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#BeginTransaction"><span class="hs-identifier hs-var">O.BeginTransaction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace -&gt; IO ()
forall trace. EntityTraceState trace -&gt; IO ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#beginTransaction"><span class="hs-identifier hs-var">beginTransaction</span></a></span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122274"><span class="hs-identifier hs-var">recorded</span></a></span><span>
</span><span id="line-649"></span><span>    </span><span class="annot"><span class="annottext">TransactionEvent
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#CommitTransaction"><span class="hs-identifier hs-var">O.CommitTransaction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace -&gt; IO ()
forall trace. EntityTraceState trace -&gt; IO ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#commitTransaction"><span class="hs-identifier hs-var">commitTransaction</span></a></span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122274"><span class="hs-identifier hs-var">recorded</span></a></span><span>
</span><span id="line-650"></span><span>    </span><span class="annot"><span class="annottext">TransactionEvent
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#RollbackTransaction"><span class="hs-identifier hs-var">O.RollbackTransaction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace -&gt; IO ()
forall trace. EntityTraceState trace -&gt; IO ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#rollbackTransaction"><span class="hs-identifier hs-var">rollbackTransaction</span></a></span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122274"><span class="hs-identifier hs-var">recorded</span></a></span><span>
</span><span id="line-651"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#NewSavepoint"><span class="hs-identifier hs-type">O.NewSavepoint</span></a></span><span> </span><span id="local-6989586621679122268"><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122268"><span class="hs-identifier hs-var">savepoint</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Savepoint -&gt; EntityTraceState trace -&gt; IO ()
forall trace. Savepoint -&gt; EntityTraceState trace -&gt; IO ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#newSavepoint"><span class="hs-identifier hs-var">newSavepoint</span></a></span><span> </span><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122268"><span class="hs-identifier hs-var">savepoint</span></a></span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122274"><span class="hs-identifier hs-var">recorded</span></a></span><span>
</span><span id="line-652"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#ReleaseSavepoint"><span class="hs-identifier hs-type">O.ReleaseSavepoint</span></a></span><span> </span><span id="local-6989586621679122266"><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122266"><span class="hs-identifier hs-var">savepoint</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Savepoint -&gt; EntityTraceState trace -&gt; IO ()
forall trace. Savepoint -&gt; EntityTraceState trace -&gt; IO ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#releaseSavepoint"><span class="hs-identifier hs-var">releaseSavepoint</span></a></span><span> </span><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122266"><span class="hs-identifier hs-var">savepoint</span></a></span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122274"><span class="hs-identifier hs-var">recorded</span></a></span><span>
</span><span id="line-653"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#RollbackToSavepoint"><span class="hs-identifier hs-type">O.RollbackToSavepoint</span></a></span><span> </span><span id="local-6989586621679122264"><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122264"><span class="hs-identifier hs-var">savepoint</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Savepoint -&gt; EntityTraceState trace -&gt; IO ()
forall trace. Savepoint -&gt; EntityTraceState trace -&gt; IO ()
</span><a href="Orville.PostgreSQL.EntityTrace.html#rollbackToSavepoint"><span class="hs-identifier hs-var">rollbackToSavepoint</span></a></span><span> </span><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679122264"><span class="hs-identifier hs-var">savepoint</span></a></span><span> </span><span class="annot"><span class="annottext">EntityTraceState trace
</span><a href="#local-6989586621679122274"><span class="hs-identifier hs-var">recorded</span></a></span><span>
</span><span id="line-654"></span><span>
</span><span id="line-655"></span><span class="hs-comment">{- |
  INTERNAL: This error is raised by the transaction callback functions if
  the 'TransactionStack' is not in the expected state. If this is ever raised
  it is either a bug in orville, or a user executing transaction sql directly
  rather than going throw 'O.withTransaction'.
-}</span><span>
</span><span id="line-661"></span><span class="hs-keyword">newtype</span><span> </span><span id="EntityTraceTransactionStateError"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceTransactionStateError"><span class="hs-identifier hs-var">EntityTraceTransactionStateError</span></a></span></span><span>
</span><span id="line-662"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="EntityTraceTransactionStateError"><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceTransactionStateError"><span class="hs-identifier hs-var">EntityTraceTransactionStateError</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-663"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679122257"><span id="local-6989586621679122259"><span id="local-6989586621679122261"><span class="annot"><span class="annottext">Int -&gt; EntityTraceTransactionStateError -&gt; ShowS
[EntityTraceTransactionStateError] -&gt; ShowS
EntityTraceTransactionStateError -&gt; String
(Int -&gt; EntityTraceTransactionStateError -&gt; ShowS)
-&gt; (EntityTraceTransactionStateError -&gt; String)
-&gt; ([EntityTraceTransactionStateError] -&gt; ShowS)
-&gt; Show EntityTraceTransactionStateError
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [EntityTraceTransactionStateError] -&gt; ShowS
$cshowList :: [EntityTraceTransactionStateError] -&gt; ShowS
show :: EntityTraceTransactionStateError -&gt; String
$cshow :: EntityTraceTransactionStateError -&gt; String
showsPrec :: Int -&gt; EntityTraceTransactionStateError -&gt; ShowS
$cshowsPrec :: Int -&gt; EntityTraceTransactionStateError -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-664"></span><span>
</span><span id="line-665"></span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#beginTransactionStateError"><span class="hs-identifier hs-type">beginTransactionStateError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceTransactionStateError"><span class="hs-identifier hs-type">EntityTraceTransactionStateError</span></a></span><span>
</span><span id="line-666"></span><span id="beginTransactionStateError"><span class="annot"><span class="annottext">beginTransactionStateError :: EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#beginTransactionStateError"><span class="hs-identifier hs-var hs-var">beginTransactionStateError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-667"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceTransactionStateError"><span class="hs-identifier hs-var">EntityTraceTransactionStateError</span></a></span><span>
</span><span id="line-668"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Got BeginTransaction callback, but the EntityTraceState was already tracking a transaction.&quot;</span></span><span>
</span><span id="line-669"></span><span>
</span><span id="line-670"></span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#commitTransactionStateError"><span class="hs-identifier hs-type">commitTransactionStateError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceTransactionStateError"><span class="hs-identifier hs-type">EntityTraceTransactionStateError</span></a></span><span>
</span><span id="line-671"></span><span id="commitTransactionStateError"><span class="annot"><span class="annottext">commitTransactionStateError :: EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#commitTransactionStateError"><span class="hs-identifier hs-var hs-var">commitTransactionStateError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-672"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceTransactionStateError"><span class="hs-identifier hs-var">EntityTraceTransactionStateError</span></a></span><span>
</span><span id="line-673"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Got CommitTransaction callback, but the EntityTraceState was not tracking a transaction.&quot;</span></span><span>
</span><span id="line-674"></span><span>
</span><span id="line-675"></span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#rollbackTransactionStateError"><span class="hs-identifier hs-type">rollbackTransactionStateError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceTransactionStateError"><span class="hs-identifier hs-type">EntityTraceTransactionStateError</span></a></span><span>
</span><span id="line-676"></span><span id="rollbackTransactionStateError"><span class="annot"><span class="annottext">rollbackTransactionStateError :: EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#rollbackTransactionStateError"><span class="hs-identifier hs-var hs-var">rollbackTransactionStateError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-677"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceTransactionStateError"><span class="hs-identifier hs-var">EntityTraceTransactionStateError</span></a></span><span>
</span><span id="line-678"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Got RollbackTransaction callback, but the EntityTraceState was not tracking a transaction.&quot;</span></span><span>
</span><span id="line-679"></span><span>
</span><span id="line-680"></span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#newSavepointTransactionStateError"><span class="hs-identifier hs-type">newSavepointTransactionStateError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceTransactionStateError"><span class="hs-identifier hs-type">EntityTraceTransactionStateError</span></a></span><span>
</span><span id="line-681"></span><span id="newSavepointTransactionStateError"><span class="annot"><span class="annottext">newSavepointTransactionStateError :: EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#newSavepointTransactionStateError"><span class="hs-identifier hs-var hs-var">newSavepointTransactionStateError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-682"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceTransactionStateError"><span class="hs-identifier hs-var">EntityTraceTransactionStateError</span></a></span><span>
</span><span id="line-683"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Got NewSavepoint callback, but the EntityTraceState was not tracking a transaction.&quot;</span></span><span>
</span><span id="line-684"></span><span>
</span><span id="line-685"></span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#releaseSavepointNoTransactionError"><span class="hs-identifier hs-type">releaseSavepointNoTransactionError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceTransactionStateError"><span class="hs-identifier hs-type">EntityTraceTransactionStateError</span></a></span><span>
</span><span id="line-686"></span><span id="releaseSavepointNoTransactionError"><span class="annot"><span class="annottext">releaseSavepointNoTransactionError :: EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#releaseSavepointNoTransactionError"><span class="hs-identifier hs-var hs-var">releaseSavepointNoTransactionError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-687"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceTransactionStateError"><span class="hs-identifier hs-var">EntityTraceTransactionStateError</span></a></span><span>
</span><span id="line-688"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Got ReleaseSavepoint callback, but the EntityTraceState was not tracking a transaction.&quot;</span></span><span>
</span><span id="line-689"></span><span>
</span><span id="line-690"></span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#releaseSavepointNoMatchingSavepointError"><span class="hs-identifier hs-type">releaseSavepointNoMatchingSavepointError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceTransactionStateError"><span class="hs-identifier hs-type">EntityTraceTransactionStateError</span></a></span><span>
</span><span id="line-691"></span><span id="releaseSavepointNoMatchingSavepointError"><span class="annot"><span class="annottext">releaseSavepointNoMatchingSavepointError :: EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#releaseSavepointNoMatchingSavepointError"><span class="hs-identifier hs-var hs-var">releaseSavepointNoMatchingSavepointError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-692"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceTransactionStateError"><span class="hs-identifier hs-var">EntityTraceTransactionStateError</span></a></span><span>
</span><span id="line-693"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Got ReleaseSavepoint callback, but the EntityTraceState did not have a matching savepoint.&quot;</span></span><span>
</span><span id="line-694"></span><span>
</span><span id="line-695"></span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#rollbackToSavepointNoTransactionError"><span class="hs-identifier hs-type">rollbackToSavepointNoTransactionError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceTransactionStateError"><span class="hs-identifier hs-type">EntityTraceTransactionStateError</span></a></span><span>
</span><span id="line-696"></span><span id="rollbackToSavepointNoTransactionError"><span class="annot"><span class="annottext">rollbackToSavepointNoTransactionError :: EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#rollbackToSavepointNoTransactionError"><span class="hs-identifier hs-var hs-var">rollbackToSavepointNoTransactionError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-697"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceTransactionStateError"><span class="hs-identifier hs-var">EntityTraceTransactionStateError</span></a></span><span>
</span><span id="line-698"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Got RollbackToSavepoint callback, but the EntityTraceState was not tracking a transaction.&quot;</span></span><span>
</span><span id="line-699"></span><span>
</span><span id="line-700"></span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#rollbackToSavepointNoMatchingSavepointError"><span class="hs-identifier hs-type">rollbackToSavepointNoMatchingSavepointError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceTransactionStateError"><span class="hs-identifier hs-type">EntityTraceTransactionStateError</span></a></span><span>
</span><span id="line-701"></span><span id="rollbackToSavepointNoMatchingSavepointError"><span class="annot"><span class="annottext">rollbackToSavepointNoMatchingSavepointError :: EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#rollbackToSavepointNoMatchingSavepointError"><span class="hs-identifier hs-var hs-var">rollbackToSavepointNoMatchingSavepointError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-702"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceTransactionStateError"><span class="hs-identifier hs-var">EntityTraceTransactionStateError</span></a></span><span>
</span><span id="line-703"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Got RollbackToSavepoint callback, but the EntityTraceState did not have a matching savepoint.&quot;</span></span><span>
</span><span id="line-704"></span><span>
</span><span id="line-705"></span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#transactionStillOpenAtEndError"><span class="hs-identifier hs-type">transactionStillOpenAtEndError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceTransactionStateError"><span class="hs-identifier hs-type">EntityTraceTransactionStateError</span></a></span><span>
</span><span id="line-706"></span><span id="transactionStillOpenAtEndError"><span class="annot"><span class="annottext">transactionStillOpenAtEndError :: EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#transactionStillOpenAtEndError"><span class="hs-identifier hs-var hs-var">transactionStillOpenAtEndError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-707"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; EntityTraceTransactionStateError
</span><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceTransactionStateError"><span class="hs-identifier hs-var">EntityTraceTransactionStateError</span></a></span><span>
</span><span id="line-708"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Finished runEntityTraceT with a transactions still open in the EntityTraceState.&quot;</span></span><span>
</span><span id="line-709"></span><span>
</span><span id="line-710"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679122248"><span id="local-6989586621679122250"><span id="local-6989586621679122252"><span class="annot"><span class="hs-identifier hs-type">Ex.Exception</span></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.EntityTrace.html#EntityTraceTransactionStateError"><span class="hs-identifier hs-type">EntityTraceTransactionStateError</span></a></span></span></span></span><span>
</span><span id="line-711"></span></pre></body></html>
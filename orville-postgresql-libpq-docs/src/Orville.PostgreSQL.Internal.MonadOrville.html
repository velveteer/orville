<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Orville.PostgreSQL.Internal.MonadOrville</span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#MonadOrville"><span class="hs-identifier">MonadOrville</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#MonadOrvilleControl"><span class="hs-identifier">MonadOrvilleControl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#liftWithConnection"><span class="hs-identifier">liftWithConnection</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#liftFinally"><span class="hs-identifier">liftFinally</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#liftBracket"><span class="hs-identifier">liftBracket</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#withConnection"><span class="hs-identifier">withConnection</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#withConnectedState"><span class="hs-identifier">withConnectedState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.IO.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Reader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ReaderT</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">runReaderT</span></span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Pool</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">withResource</span></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Connection.html"><span class="hs-identifier">Orville.PostgreSQL.Connection</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.Connection.html#Connection"><span class="hs-identifier">Connection</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html"><span class="hs-identifier">Orville.PostgreSQL.Internal.OrvilleState</span></a></span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#ConnectedState"><span class="hs-identifier">ConnectedState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#ConnectedState"><span class="hs-identifier">ConnectedState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#connectedConnection"><span class="hs-identifier">connectedConnection</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#connectedTransaction"><span class="hs-identifier">connectedTransaction</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#ConnectionState"><span class="hs-identifier">ConnectionState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#Connected"><span class="hs-identifier">Connected</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#NotConnected"><span class="hs-identifier">NotConnected</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#HasOrvilleState"><span class="hs-identifier">HasOrvilleState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#askOrvilleState"><span class="hs-identifier">askOrvilleState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#localOrvilleState"><span class="hs-identifier">localOrvilleState</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#OrvilleState"><span class="hs-identifier">OrvilleState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#connectState"><span class="hs-identifier">connectState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#orvilleConnectionPool"><span class="hs-identifier">orvilleConnectionPool</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#orvilleConnectionState"><span class="hs-identifier">orvilleConnectionState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span class="hs-comment">{- |
  'MonadOrville' is the typeclass that most Orville operations require to
  do anything that connects to the database. 'MonadOrville' itself is empty,
  but it lists all the required typeclasses as superclass contraints so that
  it can be used instead of listing all the constraints on every function.

  If you want to be able to run Orville operations directly in your own
  application's Monad stack, a good starting place is to add

  @
    instance MonadOrville MyApplicationMonad
  @

  to your module and then let the compiler tell you what instances you
  are missing from the superclasses.
-}</span><span>
</span><span id="line-43"></span><span class="hs-keyword">class</span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#HasOrvilleState"><span class="hs-identifier hs-type">HasOrvilleState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679117739"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679117739"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679117739"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-48"></span><span>  </span><span id="MonadOrville"><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#MonadOrville"><span class="hs-identifier hs-var">MonadOrville</span></a></span></span><span> </span><span id="local-6989586621679117739"><span class="annot"><a href="#local-6989586621679117739"><span class="hs-identifier hs-type">m</span></a></span></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-comment">{- |
  'MonadOrvilleControl' presents the interface that Orville will used to
  lift low-level IO operations that cannot be lifted via 'liftIO' (i.e.
  those where the IO parameter is contravriant rather than covariant).

  For application monads built using only 'ReaderT' and 'IO', this can be
  trivially implemented (or derived), using the 'ReaderT' instance that is
  provided here. If you monad stack is sufficiently complicated, you may
  need to use the 'unliftio' package as a stepping stone to implementing
  'MonadOrvilleControl'. If your monad uses features that 'unliftio' cannot
  support (e.g. the State monad or continuations), then you may need to
  use 'monad-control' instead.

  TODO: Orville will provide helpers for using 'unliftio' and 'monad-control',
  before release, we just haven't gotten quite there yet.
-}</span><span>
</span><span id="line-66"></span><span class="hs-keyword">class</span><span> </span><span id="MonadOrvilleControl"><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#MonadOrvilleControl"><span class="hs-identifier hs-var">MonadOrvilleControl</span></a></span></span><span> </span><span id="local-6989586621679117775"><span class="annot"><a href="#local-6989586621679117775"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-67"></span><span>  </span><span class="hs-comment">{-
    Orville will use this function to lift the acquisition of connections
    from the resource pool into the application monad.
  -}</span><span>
</span><span id="line-71"></span><span>  </span><span id="local-6989586621679117784"><span id="liftWithConnection"><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#liftWithConnection"><span class="hs-identifier hs-type">liftWithConnection</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679117785"><span class="annot"><a href="#local-6989586621679117785"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679117785"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679117785"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679117775"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679117784"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679117775"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679117784"><span class="hs-identifier hs-type">b</span></a></span></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-comment">{-
    Orville will use this function to resource cleanup actions from IO
    into the application monad.
  -}</span><span>
</span><span id="line-78"></span><span>  </span><span id="local-6989586621679117780"><span id="local-6989586621679117781"><span id="liftFinally"><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#liftFinally"><span class="hs-identifier hs-type">liftFinally</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679117783"><span class="annot"><a href="#local-6989586621679117783"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679117782"><span class="annot"><a href="#local-6989586621679117782"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679117783"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679117782"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679117783"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679117775"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679117781"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679117775"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679117780"><span class="hs-identifier hs-type">d</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679117775"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679117781"><span class="hs-identifier hs-type">c</span></a></span></span></span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-comment">{-
    Orville will use this function to lift resource allocation and cleanup
    from IO into the application monad.
  -}</span><span>
</span><span id="line-84"></span><span>  </span><span id="local-6989586621679117777"><span id="local-6989586621679117778"><span id="local-6989586621679117779"><span id="liftBracket"><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#liftBracket"><span class="hs-identifier hs-type">liftBracket</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679117779"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679117779"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679117778"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679117779"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679117777"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679117777"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-86"></span><span>    </span><span class="annot"><a href="#local-6989586621679117775"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679117779"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679117779"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679117775"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679117778"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679117779"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679117775"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679117777"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-89"></span><span>    </span><span class="annot"><a href="#local-6989586621679117775"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679117777"><span class="hs-identifier hs-type">c</span></a></span></span></span></span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-92"></span><span>  </span><span id="local-6989586621679117698"><span class="annot"><span class="annottext">liftWithConnection :: (forall a. (Connection -&gt; IO a) -&gt; IO a)
-&gt; (Connection -&gt; IO b) -&gt; IO b
</span><a href="#local-6989586621679117698"><span class="hs-identifier hs-var hs-var hs-var hs-var">liftWithConnection</span></a></span></span><span> </span><span id="local-6989586621679117697"><span class="annot"><span class="annottext">forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="#local-6989586621679117697"><span class="hs-identifier hs-var">ioWithConn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-93"></span><span>    </span><span class="annot"><span class="annottext">(Connection -&gt; IO b) -&gt; IO b
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="#local-6989586621679117697"><span class="hs-identifier hs-var">ioWithConn</span></a></span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span>  </span><span id="local-6989586621679117696"><span class="annot"><span class="annottext">liftFinally :: (forall a b. IO a -&gt; IO b -&gt; IO a) -&gt; IO c -&gt; IO d -&gt; IO c
</span><a href="#local-6989586621679117696"><span class="hs-identifier hs-var hs-var hs-var hs-var">liftFinally</span></a></span></span><span> </span><span id="local-6989586621679117695"><span class="annot"><span class="annottext">forall a b. IO a -&gt; IO b -&gt; IO a
</span><a href="#local-6989586621679117695"><span class="hs-identifier hs-var">ioFinally</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-96"></span><span>    </span><span class="annot"><span class="annottext">IO c -&gt; IO d -&gt; IO c
forall a b. IO a -&gt; IO b -&gt; IO a
</span><a href="#local-6989586621679117695"><span class="hs-identifier hs-var">ioFinally</span></a></span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span>  </span><span id="local-6989586621679117694"><span class="annot"><span class="annottext">liftBracket :: (IO a -&gt; (a -&gt; IO b) -&gt; (a -&gt; IO c) -&gt; IO c)
-&gt; IO a -&gt; (a -&gt; IO b) -&gt; (a -&gt; IO c) -&gt; IO c
</span><a href="#local-6989586621679117694"><span class="hs-identifier hs-var hs-var hs-var hs-var">liftBracket</span></a></span></span><span> </span><span id="local-6989586621679117693"><span class="annot"><span class="annottext">IO a -&gt; (a -&gt; IO b) -&gt; (a -&gt; IO c) -&gt; IO c
</span><a href="#local-6989586621679117693"><span class="hs-identifier hs-var">ioBracket</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-99"></span><span>    </span><span class="annot"><span class="annottext">IO a -&gt; (a -&gt; IO b) -&gt; (a -&gt; IO c) -&gt; IO c
</span><a href="#local-6989586621679117693"><span class="hs-identifier hs-var">ioBracket</span></a></span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span id="local-6989586621679117691"><span id="local-6989586621679117692"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679117692"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="#local-6989586621679117691"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679117692"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-102"></span><span>  </span><span id="local-6989586621679117687"><span class="annot"><span class="annottext">liftWithConnection :: (forall a. (Connection -&gt; IO a) -&gt; IO a)
-&gt; (Connection -&gt; ReaderT state m b) -&gt; ReaderT state m b
</span><a href="#local-6989586621679117687"><span class="hs-identifier hs-var hs-var hs-var hs-var">liftWithConnection</span></a></span></span><span> </span><span id="local-6989586621679117686"><span class="annot"><span class="annottext">forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="#local-6989586621679117686"><span class="hs-identifier hs-var">ioWithConn</span></a></span></span><span> </span><span id="local-6989586621679117685"><span class="annot"><span class="annottext">Connection -&gt; ReaderT state m b
</span><a href="#local-6989586621679117685"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><span class="annottext">(state -&gt; m b) -&gt; ReaderT state m b
forall r (m :: * -&gt; *) a. (r -&gt; m a) -&gt; ReaderT r m a
</span><span class="hs-identifier hs-var">ReaderT</span></span><span> </span><span class="annot"><span class="annottext">((state -&gt; m b) -&gt; ReaderT state m b)
-&gt; (state -&gt; m b) -&gt; ReaderT state m b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679117684"><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679117684"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-104"></span><span>      </span><span class="annot"><span class="annottext">(forall a. (Connection -&gt; IO a) -&gt; IO a)
-&gt; (Connection -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) b.
MonadOrvilleControl m =&gt;
(forall a. (Connection -&gt; IO a) -&gt; IO a)
-&gt; (Connection -&gt; m b) -&gt; m b
</span><a href="Orville.PostgreSQL.Internal.MonadOrville.html#liftWithConnection"><span class="hs-identifier hs-var">liftWithConnection</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="#local-6989586621679117686"><span class="hs-identifier hs-var">ioWithConn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ReaderT state m b -&gt; state -&gt; m b)
-&gt; state -&gt; ReaderT state m b -&gt; m b
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT state m b -&gt; state -&gt; m b
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679117684"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT state m b -&gt; m b)
-&gt; (Connection -&gt; ReaderT state m b) -&gt; Connection -&gt; m b
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Connection -&gt; ReaderT state m b
</span><a href="#local-6989586621679117685"><span class="hs-identifier hs-var">action</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span>  </span><span id="local-6989586621679117681"><span class="annot"><span class="annottext">liftFinally :: (forall a b. IO a -&gt; IO b -&gt; IO a)
-&gt; ReaderT state m c -&gt; ReaderT state m d -&gt; ReaderT state m c
</span><a href="#local-6989586621679117681"><span class="hs-identifier hs-var hs-var hs-var hs-var">liftFinally</span></a></span></span><span> </span><span id="local-6989586621679117680"><span class="annot"><span class="annottext">forall a b. IO a -&gt; IO b -&gt; IO a
</span><a href="#local-6989586621679117680"><span class="hs-identifier hs-var">ioFinally</span></a></span></span><span> </span><span id="local-6989586621679117679"><span class="annot"><span class="annottext">ReaderT state m c
</span><a href="#local-6989586621679117679"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span id="local-6989586621679117678"><span class="annot"><span class="annottext">ReaderT state m d
</span><a href="#local-6989586621679117678"><span class="hs-identifier hs-var">cleanup</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-107"></span><span>    </span><span class="annot"><span class="annottext">(state -&gt; m c) -&gt; ReaderT state m c
forall r (m :: * -&gt; *) a. (r -&gt; m a) -&gt; ReaderT r m a
</span><span class="hs-identifier hs-var">ReaderT</span></span><span> </span><span class="annot"><span class="annottext">((state -&gt; m c) -&gt; ReaderT state m c)
-&gt; (state -&gt; m c) -&gt; ReaderT state m c
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679117677"><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679117677"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-108"></span><span>      </span><span class="annot"><span class="annottext">(forall a b. IO a -&gt; IO b -&gt; IO a) -&gt; m c -&gt; m d -&gt; m c
forall (m :: * -&gt; *) c d.
MonadOrvilleControl m =&gt;
(forall a b. IO a -&gt; IO b -&gt; IO a) -&gt; m c -&gt; m d -&gt; m c
</span><a href="Orville.PostgreSQL.Internal.MonadOrville.html#liftFinally"><span class="hs-identifier hs-var">liftFinally</span></a></span><span>
</span><span id="line-109"></span><span>        </span><span class="annot"><span class="annottext">forall a b. IO a -&gt; IO b -&gt; IO a
</span><a href="#local-6989586621679117680"><span class="hs-identifier hs-var">ioFinally</span></a></span><span>
</span><span id="line-110"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ReaderT state m c -&gt; state -&gt; m c
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">ReaderT state m c
</span><a href="#local-6989586621679117679"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679117677"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ReaderT state m d -&gt; state -&gt; m d
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">ReaderT state m d
</span><a href="#local-6989586621679117678"><span class="hs-identifier hs-var">cleanup</span></a></span><span> </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679117677"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span>  </span><span id="local-6989586621679117676"><span class="annot"><span class="annottext">liftBracket :: (IO a -&gt; (a -&gt; IO b) -&gt; (a -&gt; IO c) -&gt; IO c)
-&gt; ReaderT state m a
-&gt; (a -&gt; ReaderT state m b)
-&gt; (a -&gt; ReaderT state m c)
-&gt; ReaderT state m c
</span><a href="#local-6989586621679117676"><span class="hs-identifier hs-var hs-var hs-var hs-var">liftBracket</span></a></span></span><span> </span><span id="local-6989586621679117675"><span class="annot"><span class="annottext">IO a -&gt; (a -&gt; IO b) -&gt; (a -&gt; IO c) -&gt; IO c
</span><a href="#local-6989586621679117675"><span class="hs-identifier hs-var">ioBracket</span></a></span></span><span> </span><span id="local-6989586621679117674"><span class="annot"><span class="annottext">ReaderT state m a
</span><a href="#local-6989586621679117674"><span class="hs-identifier hs-var">allocate</span></a></span></span><span> </span><span id="local-6989586621679117673"><span class="annot"><span class="annottext">a -&gt; ReaderT state m b
</span><a href="#local-6989586621679117673"><span class="hs-identifier hs-var">cleanup</span></a></span></span><span> </span><span id="local-6989586621679117672"><span class="annot"><span class="annottext">a -&gt; ReaderT state m c
</span><a href="#local-6989586621679117672"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-114"></span><span>    </span><span class="annot"><span class="annottext">(state -&gt; m c) -&gt; ReaderT state m c
forall r (m :: * -&gt; *) a. (r -&gt; m a) -&gt; ReaderT r m a
</span><span class="hs-identifier hs-var">ReaderT</span></span><span> </span><span class="annot"><span class="annottext">((state -&gt; m c) -&gt; ReaderT state m c)
-&gt; (state -&gt; m c) -&gt; ReaderT state m c
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679117671"><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679117671"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-115"></span><span>      </span><span class="annot"><span class="annottext">(IO a -&gt; (a -&gt; IO b) -&gt; (a -&gt; IO c) -&gt; IO c)
-&gt; m a -&gt; (a -&gt; m b) -&gt; (a -&gt; m c) -&gt; m c
forall (m :: * -&gt; *) a b c.
MonadOrvilleControl m =&gt;
(IO a -&gt; (a -&gt; IO b) -&gt; (a -&gt; IO c) -&gt; IO c)
-&gt; m a -&gt; (a -&gt; m b) -&gt; (a -&gt; m c) -&gt; m c
</span><a href="Orville.PostgreSQL.Internal.MonadOrville.html#liftBracket"><span class="hs-identifier hs-var">liftBracket</span></a></span><span>
</span><span id="line-116"></span><span>        </span><span class="annot"><span class="annottext">IO a -&gt; (a -&gt; IO b) -&gt; (a -&gt; IO c) -&gt; IO c
</span><a href="#local-6989586621679117675"><span class="hs-identifier hs-var">ioBracket</span></a></span><span>
</span><span id="line-117"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ReaderT state m a -&gt; state -&gt; m a
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">ReaderT state m a
</span><a href="#local-6989586621679117674"><span class="hs-identifier hs-var">allocate</span></a></span><span> </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679117671"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679117670"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679117670"><span class="hs-identifier hs-var">resource</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReaderT state m b -&gt; state -&gt; m b
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; ReaderT state m b
</span><a href="#local-6989586621679117673"><span class="hs-identifier hs-var">cleanup</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679117670"><span class="hs-identifier hs-var">resource</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679117671"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679117669"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679117669"><span class="hs-identifier hs-var">resource</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ReaderT state m c -&gt; state -&gt; m c
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; ReaderT state m c
</span><a href="#local-6989586621679117672"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679117669"><span class="hs-identifier hs-var">resource</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621679117671"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span id="local-6989586621679117668"><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679117668"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679117668"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#OrvilleState"><span class="hs-identifier hs-type">OrvilleState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679117668"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span class="hs-comment">{- |
  'withConnection' should be used to receive a 'Connection' handle for
  executing queries against the database from within an application monad using
  Orville.  For the &quot;outermost&quot; call of 'withConnection', a connection will be
  acquired from the resource pool. Additional calls to 'withConnection' that
  happen inside the 'm a' that uses the connection will return the same
  'Connection' the same connection. When the 'm a' finishes the connection
  will be returned to the pool. If 'm a' throws an exception the pool's
  exception handling will take effect, generally destroying the connection in
  case it was the source of the error.
-}</span><span>
</span><span id="line-134"></span><span id="local-6989586621679117662"><span id="local-6989586621679117663"><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#withConnection"><span class="hs-identifier hs-type">withConnection</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679117663"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.Connection.html#Connection"><span class="hs-identifier hs-type">Connection</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679117663"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679117662"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679117663"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679117662"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-135"></span><span id="withConnection"><span class="annot"><span class="annottext">withConnection :: (Connection -&gt; m a) -&gt; m a
</span><a href="Orville.PostgreSQL.Internal.MonadOrville.html#withConnection"><span class="hs-identifier hs-var hs-var">withConnection</span></a></span></span><span> </span><span id="local-6989586621679117661"><span class="annot"><span class="annottext">Connection -&gt; m a
</span><a href="#local-6989586621679117661"><span class="hs-identifier hs-var">connectedAction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-136"></span><span>  </span><span class="annot"><span class="annottext">(ConnectedState -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) a.
MonadOrville m =&gt;
(ConnectedState -&gt; m a) -&gt; m a
</span><a href="Orville.PostgreSQL.Internal.MonadOrville.html#withConnectedState"><span class="hs-identifier hs-var">withConnectedState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Connection -&gt; m a
</span><a href="#local-6989586621679117661"><span class="hs-identifier hs-var">connectedAction</span></a></span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; m a)
-&gt; (ConnectedState -&gt; Connection) -&gt; ConnectedState -&gt; m a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ConnectedState -&gt; Connection
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#connectedConnection"><span class="hs-identifier hs-var hs-var">connectedConnection</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span class="hs-comment">{- |
  INTERNAL: This in an internal version of 'withConnection' that gives access to
  the entire 'ConnectedState' value to allow for transaction management.
-}</span><span>
</span><span id="line-142"></span><span id="local-6989586621679117734"><span id="local-6989586621679117735"><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#withConnectedState"><span class="hs-identifier hs-type">withConnectedState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.MonadOrville.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679117735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#ConnectedState"><span class="hs-identifier hs-type">ConnectedState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679117735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679117734"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679117735"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679117734"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-143"></span><span id="withConnectedState"><span class="annot"><span class="annottext">withConnectedState :: (ConnectedState -&gt; m a) -&gt; m a
</span><a href="Orville.PostgreSQL.Internal.MonadOrville.html#withConnectedState"><span class="hs-identifier hs-var hs-var">withConnectedState</span></a></span></span><span> </span><span id="local-6989586621679117660"><span class="annot"><span class="annottext">ConnectedState -&gt; m a
</span><a href="#local-6989586621679117660"><span class="hs-identifier hs-var">connectedAction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-144"></span><span>  </span><span id="local-6989586621679117659"><span class="annot"><span class="annottext">OrvilleState
</span><a href="#local-6989586621679117659"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m OrvilleState
forall (m :: * -&gt; *). HasOrvilleState m =&gt; m OrvilleState
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#askOrvilleState"><span class="hs-identifier hs-var">askOrvilleState</span></a></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OrvilleState -&gt; ConnectionState
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#orvilleConnectionState"><span class="hs-identifier hs-var">orvilleConnectionState</span></a></span><span> </span><span class="annot"><span class="annottext">OrvilleState
</span><a href="#local-6989586621679117659"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-147"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#Connected"><span class="hs-identifier hs-type">Connected</span></a></span><span> </span><span id="local-6989586621679117658"><span class="annot"><span class="annottext">ConnectedState
</span><a href="#local-6989586621679117658"><span class="hs-identifier hs-var">connectedState</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-148"></span><span>      </span><span class="annot"><span class="annottext">ConnectedState -&gt; m a
</span><a href="#local-6989586621679117660"><span class="hs-identifier hs-var">connectedAction</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectedState
</span><a href="#local-6989586621679117658"><span class="hs-identifier hs-var">connectedState</span></a></span><span>
</span><span id="line-149"></span><span>    </span><span class="annot"><span class="annottext">ConnectionState
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#NotConnected"><span class="hs-identifier hs-var">NotConnected</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-150"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679117657"><span class="annot"><span class="annottext">pool :: Pool Connection
</span><a href="#local-6989586621679117657"><span class="hs-identifier hs-var hs-var">pool</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OrvilleState -&gt; Pool Connection
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#orvilleConnectionPool"><span class="hs-identifier hs-var">orvilleConnectionPool</span></a></span><span> </span><span class="annot"><span class="annottext">OrvilleState
</span><a href="#local-6989586621679117659"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-151"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(forall a. (Connection -&gt; IO a) -&gt; IO a)
-&gt; (Connection -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) b.
MonadOrvilleControl m =&gt;
(forall a. (Connection -&gt; IO a) -&gt; IO a)
-&gt; (Connection -&gt; m b) -&gt; m b
</span><a href="Orville.PostgreSQL.Internal.MonadOrville.html#liftWithConnection"><span class="hs-identifier hs-var">liftWithConnection</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pool Connection -&gt; (Connection -&gt; IO a) -&gt; IO a
forall (m :: * -&gt; *) a b.
MonadBaseControl IO m =&gt;
Pool a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">withResource</span></span><span> </span><span class="annot"><span class="annottext">Pool Connection
</span><a href="#local-6989586621679117657"><span class="hs-identifier hs-var">pool</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; m a) -&gt; m a) -&gt; (Connection -&gt; m a) -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679117656"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679117656"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-152"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679117655"><span class="annot"><span class="annottext">connectedState :: ConnectedState
</span><a href="#local-6989586621679117655"><span class="hs-identifier hs-var hs-var">connectedState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-153"></span><span>                  </span><span class="annot"><span class="annottext">ConnectedState :: Connection -&gt; Maybe TransactionState -&gt; ConnectedState
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#ConnectedState"><span class="hs-identifier hs-type">ConnectedState</span></a></span><span>
</span><span id="line-154"></span><span>                    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">connectedConnection :: Connection
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#connectedConnection"><span class="hs-identifier hs-var">connectedConnection</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679117656"><span class="hs-identifier hs-var">conn</span></a></span><span>
</span><span id="line-155"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">connectedTransaction :: Maybe TransactionState
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#connectedTransaction"><span class="hs-identifier hs-var">connectedTransaction</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe TransactionState
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-156"></span><span>                    </span><span class="hs-special">}</span><span>
</span><span id="line-157"></span><span>             </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(OrvilleState -&gt; OrvilleState) -&gt; m a -&gt; m a
forall (m :: * -&gt; *) a.
HasOrvilleState m =&gt;
(OrvilleState -&gt; OrvilleState) -&gt; m a -&gt; m a
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#localOrvilleState"><span class="hs-identifier hs-var">localOrvilleState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectedState -&gt; OrvilleState -&gt; OrvilleState
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#connectState"><span class="hs-identifier hs-var">connectState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectedState
</span><a href="#local-6989586621679117655"><span class="hs-identifier hs-var">connectedState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m a -&gt; m a) -&gt; m a -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-158"></span><span>                  </span><span class="annot"><span class="annottext">ConnectedState -&gt; m a
</span><a href="#local-6989586621679117660"><span class="hs-identifier hs-var">connectedAction</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectedState
</span><a href="#local-6989586621679117655"><span class="hs-identifier hs-var">connectedState</span></a></span><span>
</span><span id="line-159"></span></pre></body></html>
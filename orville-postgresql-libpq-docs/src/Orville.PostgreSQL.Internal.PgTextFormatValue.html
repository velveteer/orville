<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Orville.PostgreSQL.Internal.PgTextFormatValue</span><span>
</span><span id="line-2"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#PgTextFormatValue"><span class="hs-identifier">PgTextFormatValue</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-3"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#NULByteFoundError"><span class="hs-identifier">NULByteFoundError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#NULByteFoundError"><span class="hs-identifier">NULByteFoundError</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-4"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#unsafeFromByteString"><span class="hs-identifier">unsafeFromByteString</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-5"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#fromByteString"><span class="hs-identifier">fromByteString</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#toByteString"><span class="hs-identifier">toByteString</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#toBytesForLibPQ"><span class="hs-identifier">toBytesForLibPQ</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-9"></span><span class="hs-keyword">where</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Exception</span></span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-comment">{- |
  A 'PgTextFormatValue' represents raw bytes that will be passed to postgresql
  via libpq. These bytes must conform to the TEXT format of values that
  postgresql expects. In all cases postgresql will be allowed to infer the type
  of the value based on its usage in the query.

  Note that postgresql does not allow NUL bytes in text values, and the LibPQ C
  library expects text values to be given as NULL-terminated C Strings, so
  '\NUL' bytes cannot be included in a 'PgTextFormatValue'. If 'fromByteString'
  is used to construct the 'PgTextFormatValue' (normally what you should do),
  an error will be raised before libpq is called to execute the query. If
  'unsafeFromByteString' is used, the caller is expected to ensure that no
  '\NUL' bytes are present. If a '\NUL' byte is included with
  'unsafeFromByteString', the value passed to the database will be truncated at
  the '\NUL' byte because it will be interpreted as the end of the C String by
  libpq.
-}</span><span>
</span><span id="line-31"></span><span class="hs-keyword">data</span><span> </span><span id="PgTextFormatValue"><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#PgTextFormatValue"><span class="hs-identifier hs-var">PgTextFormatValue</span></a></span></span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="NoAssumptionsMade"><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#NoAssumptionsMade"><span class="hs-identifier hs-var">NoAssumptionsMade</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="AssumedToHaveNoNULValues"><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#AssumedToHaveNoNULValues"><span class="hs-identifier hs-var">AssumedToHaveNoNULValues</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679114301"><span id="local-6989586621679114303"><span id="local-6989586621679114305"><span class="annot"><span class="annottext">Int -&gt; PgTextFormatValue -&gt; ShowS
[PgTextFormatValue] -&gt; ShowS
PgTextFormatValue -&gt; String
(Int -&gt; PgTextFormatValue -&gt; ShowS)
-&gt; (PgTextFormatValue -&gt; String)
-&gt; ([PgTextFormatValue] -&gt; ShowS)
-&gt; Show PgTextFormatValue
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [PgTextFormatValue] -&gt; ShowS
$cshowList :: [PgTextFormatValue] -&gt; ShowS
show :: PgTextFormatValue -&gt; String
$cshow :: PgTextFormatValue -&gt; String
showsPrec :: Int -&gt; PgTextFormatValue -&gt; ShowS
$cshowsPrec :: Int -&gt; PgTextFormatValue -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679114297"><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#PgTextFormatValue"><span class="hs-identifier hs-type">PgTextFormatValue</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-37"></span><span>  </span><span id="local-6989586621679114295"><span class="annot"><span class="annottext">PgTextFormatValue
</span><a href="#local-6989586621679114295"><span class="hs-identifier hs-var">left</span></a></span></span><span> </span><span id="local-6989586621679114294"><span class="annot"><span class="annottext">== :: PgTextFormatValue -&gt; PgTextFormatValue -&gt; Bool
</span><span class="hs-operator hs-var hs-var hs-var hs-var">==</span></span></span><span> </span><span id="local-6989586621679114293"><span class="annot"><span class="annottext">PgTextFormatValue
</span><a href="#local-6989586621679114293"><span class="hs-identifier hs-var">right</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><span class="annottext">PgTextFormatValue -&gt; Either NULByteFoundError ByteString
</span><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#toBytesForLibPQ"><span class="hs-identifier hs-var">toBytesForLibPQ</span></a></span><span> </span><span class="annot"><span class="annottext">PgTextFormatValue
</span><a href="#local-6989586621679114295"><span class="hs-identifier hs-var">left</span></a></span><span> </span><span class="annot"><span class="annottext">Either NULByteFoundError ByteString
-&gt; Either NULByteFoundError ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">PgTextFormatValue -&gt; Either NULByteFoundError ByteString
</span><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#toBytesForLibPQ"><span class="hs-identifier hs-var">toBytesForLibPQ</span></a></span><span> </span><span class="annot"><span class="annottext">PgTextFormatValue
</span><a href="#local-6989586621679114293"><span class="hs-identifier hs-var">right</span></a></span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-keyword">data</span><span> </span><span id="NULByteFoundError"><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#NULByteFoundError"><span class="hs-identifier hs-var">NULByteFoundError</span></a></span></span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="NULByteFoundError"><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#NULByteFoundError"><span class="hs-identifier hs-var">NULByteFoundError</span></a></span></span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679114287"><span id="local-6989586621679114289"><span id="local-6989586621679114291"><span class="annot"><span class="annottext">Int -&gt; NULByteFoundError -&gt; ShowS
[NULByteFoundError] -&gt; ShowS
NULByteFoundError -&gt; String
(Int -&gt; NULByteFoundError -&gt; ShowS)
-&gt; (NULByteFoundError -&gt; String)
-&gt; ([NULByteFoundError] -&gt; ShowS)
-&gt; Show NULByteFoundError
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [NULByteFoundError] -&gt; ShowS
$cshowList :: [NULByteFoundError] -&gt; ShowS
show :: NULByteFoundError -&gt; String
$cshow :: NULByteFoundError -&gt; String
showsPrec :: Int -&gt; NULByteFoundError -&gt; ShowS
$cshowsPrec :: Int -&gt; NULByteFoundError -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679114283"><span id="local-6989586621679114285"><span class="annot"><span class="annottext">NULByteFoundError -&gt; NULByteFoundError -&gt; Bool
(NULByteFoundError -&gt; NULByteFoundError -&gt; Bool)
-&gt; (NULByteFoundError -&gt; NULByteFoundError -&gt; Bool)
-&gt; Eq NULByteFoundError
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: NULByteFoundError -&gt; NULByteFoundError -&gt; Bool
$c/= :: NULByteFoundError -&gt; NULByteFoundError -&gt; Bool
== :: NULByteFoundError -&gt; NULByteFoundError -&gt; Bool
$c== :: NULByteFoundError -&gt; NULByteFoundError -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679114275"><span id="local-6989586621679114277"><span id="local-6989586621679114279"><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#NULByteFoundError"><span class="hs-identifier hs-type">NULByteFoundError</span></a></span></span></span></span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="hs-comment">{- |
  Constructs a 'PgTextFormatValue' from the given bytes directly, without checking
  whether any of the bytes are '\NUL' or not. If a 'BS.ByteString' containing
  a '\NUL' byte is given, the value will be truncated at the '\NUL' when it
  is passed to libpq.

  This function is only safe to use when you have generated the bytestring
  in a way that guarantees no '\NUL' bytes are present, such as when serializing
  an integer value to its decimal representation.
-}</span><span>
</span><span id="line-56"></span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#unsafeFromByteString"><span class="hs-identifier hs-type">unsafeFromByteString</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#PgTextFormatValue"><span class="hs-identifier hs-type">PgTextFormatValue</span></a></span><span>
</span><span id="line-57"></span><span id="unsafeFromByteString"><span class="annot"><span class="annottext">unsafeFromByteString :: ByteString -&gt; PgTextFormatValue
</span><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#unsafeFromByteString"><span class="hs-identifier hs-var hs-var">unsafeFromByteString</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-58"></span><span>  </span><span class="annot"><span class="annottext">ByteString -&gt; PgTextFormatValue
</span><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#AssumedToHaveNoNULValues"><span class="hs-identifier hs-var">AssumedToHaveNoNULValues</span></a></span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-comment">{- |
  Constructs a 'PgTextFormatValue' from the given bytes, which will be checked
  to ensure none of them are '\NUL' before being passed to libpq. If a '\NUL'
  byte is found an error will be raised.
-}</span><span>
</span><span id="line-65"></span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#fromByteString"><span class="hs-identifier hs-type">fromByteString</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#PgTextFormatValue"><span class="hs-identifier hs-type">PgTextFormatValue</span></a></span><span>
</span><span id="line-66"></span><span id="fromByteString"><span class="annot"><span class="annottext">fromByteString :: ByteString -&gt; PgTextFormatValue
</span><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#fromByteString"><span class="hs-identifier hs-var hs-var">fromByteString</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-67"></span><span>  </span><span class="annot"><span class="annottext">ByteString -&gt; PgTextFormatValue
</span><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#NoAssumptionsMade"><span class="hs-identifier hs-var">NoAssumptionsMade</span></a></span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="hs-comment">{- |
  Converts the 'PgTextFormatValue' to bytes intended to be passed to libpq.
  If any '\NUL' bytes are found, 'NULByteErrorFound' will be returned (unless
  'unsafeFromByteString' was used to construct the value).
-}</span><span>
</span><span id="line-74"></span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#toBytesForLibPQ"><span class="hs-identifier hs-type">toBytesForLibPQ</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#PgTextFormatValue"><span class="hs-identifier hs-type">PgTextFormatValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#NULByteFoundError"><span class="hs-identifier hs-type">NULByteFoundError</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span>
</span><span id="line-75"></span><span id="toBytesForLibPQ"><span class="annot"><span class="annottext">toBytesForLibPQ :: PgTextFormatValue -&gt; Either NULByteFoundError ByteString
</span><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#toBytesForLibPQ"><span class="hs-identifier hs-var hs-var">toBytesForLibPQ</span></a></span></span><span> </span><span id="local-6989586621679114273"><span class="annot"><span class="annottext">PgTextFormatValue
</span><a href="#local-6989586621679114273"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-76"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PgTextFormatValue
</span><a href="#local-6989586621679114273"><span class="hs-identifier hs-var">value</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-77"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#AssumedToHaveNoNULValues"><span class="hs-identifier hs-type">AssumedToHaveNoNULValues</span></a></span><span> </span><span id="local-6989586621679114272"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679114272"><span class="hs-identifier hs-var">noNULBytes</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-78"></span><span>      </span><span class="annot"><span class="annottext">ByteString -&gt; Either NULByteFoundError ByteString
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679114272"><span class="hs-identifier hs-var">noNULBytes</span></a></span><span>
</span><span id="line-79"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#NoAssumptionsMade"><span class="hs-identifier hs-type">NoAssumptionsMade</span></a></span><span> </span><span id="local-6989586621679114271"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679114271"><span class="hs-identifier hs-var">anyBytes</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-80"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; ByteString -&gt; Bool
</span><span class="hs-identifier hs-var">BS.elem</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679114271"><span class="hs-identifier hs-var">anyBytes</span></a></span><span>
</span><span id="line-81"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">NULByteFoundError -&gt; Either NULByteFoundError ByteString
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">NULByteFoundError
</span><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#NULByteFoundError"><span class="hs-identifier hs-var">NULByteFoundError</span></a></span><span>
</span><span id="line-82"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Either NULByteFoundError ByteString
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679114271"><span class="hs-identifier hs-var">anyBytes</span></a></span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="hs-comment">{- |
  Convents the 'PgTextFormatValue' back to the bytes that were used to
  construct it, losing the information about whether it would be checked
  for '\NUL' bytes or not.
-}</span><span>
</span><span id="line-89"></span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#toByteString"><span class="hs-identifier hs-type">toByteString</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#PgTextFormatValue"><span class="hs-identifier hs-type">PgTextFormatValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span>
</span><span id="line-90"></span><span id="toByteString"><span class="annot"><span class="annottext">toByteString :: PgTextFormatValue -&gt; ByteString
</span><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#toByteString"><span class="hs-identifier hs-var hs-var">toByteString</span></a></span></span><span> </span><span id="local-6989586621679114269"><span class="annot"><span class="annottext">PgTextFormatValue
</span><a href="#local-6989586621679114269"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-91"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PgTextFormatValue
</span><a href="#local-6989586621679114269"><span class="hs-identifier hs-var">value</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-92"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#AssumedToHaveNoNULValues"><span class="hs-identifier hs-type">AssumedToHaveNoNULValues</span></a></span><span> </span><span id="local-6989586621679114268"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679114268"><span class="hs-identifier hs-var">bytes</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-93"></span><span>      </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679114268"><span class="hs-identifier hs-var">bytes</span></a></span><span>
</span><span id="line-94"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.PgTextFormatValue.html#NoAssumptionsMade"><span class="hs-identifier hs-type">NoAssumptionsMade</span></a></span><span> </span><span id="local-6989586621679114267"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679114267"><span class="hs-identifier hs-var">bytes</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-95"></span><span>      </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679114267"><span class="hs-identifier hs-var">bytes</span></a></span><span>
</span><span id="line-96"></span></pre></body></html>